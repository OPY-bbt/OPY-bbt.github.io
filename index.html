<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="前路漫漫 唯风作伴">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="前路漫漫 唯风作伴">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="前路漫漫 唯风作伴">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>前路漫漫 唯风作伴</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">前路漫漫 唯风作伴</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">脚踏大地 仰望星空</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/07/dva-源码解析-下/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/07/dva-源码解析-下/" itemprop="url">dva-源码解析-下</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-07T22:04:09+08:00">
                2018-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先这是一篇找妈妈的故事， model中的state，reducers，effects，是如何找到各自的妈妈呢？23333～</p>
<p>dva 是对redux、react-redux、react-router、redux-saga的整合，所以在看dva源码之前建议先要熟悉这些库的用法。<br>废话不多说，那我们就开始。先看一下生成的 index.js 文件，在这里我加入了dva-loading，用来分析plugin。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dva <span class="keyword">from</span> <span class="string">'dva'</span>;</span><br><span class="line"><span class="keyword">import</span> createLoading <span class="keyword">from</span> <span class="string">'dva-loading'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Initialize</span></span><br><span class="line"><span class="keyword">const</span> app = dva();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Plugins</span></span><br><span class="line">app.use(createLoading());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Model</span></span><br><span class="line">app.model(<span class="built_in">require</span>(<span class="string">'./models/example'</span>).default);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Router</span></span><br><span class="line">app.router(<span class="built_in">require</span>(<span class="string">'./router'</span>).default);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. Start</span></span><br><span class="line">app.start(<span class="string">'#root'</span>);</span><br></pre></td></tr></table></figure></p>
<p>可以看到，dva生成app实例，并且绑定plugin、models、router，最后启动项目。</p>
<p>先去看一下dva的源码，位置是dva/src/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params">opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> history = opts.history || createHashHistory();</span><br><span class="line">  <span class="keyword">const</span> createOpts = &#123;</span><br><span class="line">    initialReducer: &#123;</span><br><span class="line">      routing,</span><br><span class="line">    &#125;,</span><br><span class="line">    setupMiddlewares(middlewares) &#123;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        routerMiddleware(history),</span><br><span class="line">        ...middlewares,</span><br><span class="line">      ];</span><br><span class="line">    &#125;,</span><br><span class="line">    setupApp(app) &#123;</span><br><span class="line">      app._history = patchHistory(history);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> app = core.create(opts, createOpts);</span><br><span class="line">  <span class="keyword">const</span> oldAppStart = app.start;</span><br><span class="line">  app.router = router;</span><br><span class="line">  app.start = start;</span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">router</span>(<span class="params">router</span>) </span>&#123;</span><br><span class="line">    app._router = router;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">container</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 允许 container 是字符串，然后用 querySelector 找元素</span></span><br><span class="line">    <span class="keyword">if</span> (isString(container)) &#123;</span><br><span class="line">      container = <span class="built_in">document</span>.querySelector(container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!app._store) &#123;</span><br><span class="line">      oldAppStart.call(app);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> store = app._store;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If has container, render; else, return react component</span></span><br><span class="line">    <span class="keyword">if</span> (container) &#123;</span><br><span class="line">      render(container, store, app, app._router);</span><br><span class="line">      app._plugin.apply(<span class="string">'onHmr'</span>)(render.bind(<span class="literal">null</span>, container, store, app));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> getProvider(store, <span class="keyword">this</span>, <span class="keyword">this</span>._router);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码重点在两句</p>
<ul>
<li><code>const app = core.create(opts, createOpts);</code> 利用dva-core生成数据层app</li>
<li><code>app.start = start;</code> 由于dva-core仅仅是数据层，所以这里需要代理start方法，建立view层，比如react、router</li>
</ul>
<p>接下来我想会重点分析model方法（这是整个dva的核心部分） 位置是dva-core/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">hooksAndOpts = &#123;&#125;, createOpts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; initialReducer, setupApp = noop &#125; = createOpts;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> plugin = <span class="keyword">new</span> Plugin();</span><br><span class="line">  plugin.use(filterHooks(hooksAndOpts));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> app = &#123;</span><br><span class="line">    _models: [prefixNamespace(&#123; ...dvaModel &#125;)],</span><br><span class="line">    _store: <span class="literal">null</span>,</span><br><span class="line">    _plugin: plugin,</span><br><span class="line">    use: plugin.use.bind(plugin),</span><br><span class="line">    model,</span><br><span class="line">    start,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册model，将model里的reducers与effects方法增加namespace，并且保存在app._models中</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">model</span>(<span class="params">m</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      checkModel(m, app._models);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> prefixedModel = prefixNamespace(&#123; ...m &#125;);</span><br><span class="line">    app._models.push(prefixedModel);</span><br><span class="line">    <span class="keyword">return</span> prefixedModel;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在一个项目中我们会注册多个model，现在models都已经被存在了app_models中。dva是如何将每个model里的state，reducers， effects，<br>放在redux与redux-saga中的呢？答案就在 app.start 里。start里主要是redux和redux-saga的初始化<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reducers = &#123; ...initialReducer &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> m <span class="keyword">of</span> app._models) &#123;</span><br><span class="line">  reducers[m.namespace] = getReducer(</span><br><span class="line">    m.reducers,</span><br><span class="line">    m.state,</span><br><span class="line">    plugin._handleActions</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (m.effects)</span><br><span class="line">    sagas.push(app._getSaga(m.effects, m, onError, plugin.get(<span class="string">'onEffect'</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码遍历models分别将reducers和effects存下来，先看一下reducer的处理<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">getReducer</span>(<span class="params">reducers, state, handleActions</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Support reducer enhancer</span></span><br><span class="line">  <span class="comment">// e.g. reducers: [realReducers, enhancer]</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(reducers)) &#123;</span><br><span class="line">    <span class="keyword">return</span> reducers[<span class="number">1</span>](</span><br><span class="line">      (handleActions || defaultHandleActions)(reducers[<span class="number">0</span>], state)</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (handleActions || defaultHandleActions)(reducers || &#123;&#125;, state);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一般情况下都不会是数组，话说看到这里我才知道原来还可以加一个enhancer。在去看一下<code>defaultHandleActions</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleActions</span>(<span class="params">handlers, defaultState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reducers = <span class="built_in">Object</span>.keys(handlers).map(<span class="function"><span class="params">type</span> =&gt;</span></span><br><span class="line">    handleAction(type, handlers[type])</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> reducer = reduceReducers(...reducers);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">state = defaultState, action</span>) =&gt;</span> reducer(state, action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里遍历了reducers里的每一个key值，并把一个models下的reduers合并为一个。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleAction</span>(<span class="params">actionType, reducer = identify</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type &#125; = action;</span><br><span class="line">    invariant(type, <span class="string">'dispatch: action should be a plain Object with type'</span>);</span><br><span class="line">    <span class="keyword">if</span> (actionType === type) &#123;</span><br><span class="line">      <span class="keyword">return</span> reducer(state, action);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键在于 <code>if (actionType === type)</code>, 判断类型不同就返回state，类似于 switch…case。<br>下面看一下合并reducer的函数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reduceReducers</span>(<span class="params">...reducers</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">previous, current</span>) =&gt;</span></span><br><span class="line">    reducers.reduce(<span class="function">(<span class="params">p, r</span>) =&gt;</span> r(p, current), previous);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的合并方式我是有点不太理解的，<br>这里采用的是reducer1 -&gt; reducer2 -&gt; reducer3,假如有一个action，models里的handleAction要全跑一遍。<br>为什么不直接找到相应键值的reducer运行呢？，reducer已经分析完了然后就是effects<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">getSaga</span>(<span class="params">effects, model, onError, onEffect</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> effects) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(effects, key)) &#123;</span><br><span class="line">        <span class="keyword">const</span> watcher = getWatcher(key, effects[key], model, onError, onEffect);</span><br><span class="line">        <span class="keyword">const</span> task = <span class="keyword">yield</span> sagaEffects.fork(watcher);</span><br><span class="line">        <span class="keyword">yield</span> sagaEffects.fork(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">yield</span> sagaEffects.take(<span class="string">`<span class="subst">$&#123;model.namespace&#125;</span>/@@CANCEL_EFFECTS`</span>);</span><br><span class="line">          <span class="keyword">yield</span> sagaEffects.cancel(task);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fork每一个effect，然后是 getWatcher 函数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onEffect就是plugin中的OnEffect， 就如开头的那个例子dva-loading中就有一个onEffect</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWatcher</span>(<span class="params">key, _effect, model, onError, onEffect</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 这里给每一个effect增加了开始、结束的事件和错误处理，并且__dva_resolve， __dva_reject是PromiseMiddleware的参数。</span></span><br><span class="line">  <span class="comment">// PromiseMiddleware的作用是当你dispatch effect时，返回一个promise。this.props.dispatch.then这样的写法你一定熟悉。</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>* <span class="title">sagaWithCatch</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">__dva_resolve</span>: resolve = noop, <span class="attr">__dva_reject</span>: reject = noop &#125; =</span><br><span class="line">      args.length &gt; <span class="number">0</span> ? args[<span class="number">0</span>] : &#123;&#125;;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">yield</span> sagaEffects.put(&#123; <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;key&#125;</span><span class="subst">$&#123;NAMESPACE_SEP&#125;</span>@@start`</span> &#125;);</span><br><span class="line">      <span class="comment">// createEffects 封装了redux-saga的effects，主要是改变了type值，这就是你为什么可以在当前model里省略namespace的原因</span></span><br><span class="line">      <span class="keyword">const</span> ret = <span class="keyword">yield</span> effect(...args.concat(createEffects(model)));</span><br><span class="line">      <span class="keyword">yield</span> sagaEffects.put(&#123; <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;key&#125;</span><span class="subst">$&#123;NAMESPACE_SEP&#125;</span>@@end`</span> &#125;);</span><br><span class="line">      resolve(ret);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      onError(e, &#123;</span><br><span class="line">        key,</span><br><span class="line">        effectArgs: args,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (!e._dontReject) &#123;</span><br><span class="line">        reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果插件中有onEffects，则再封装一层</span></span><br><span class="line">  <span class="keyword">const</span> sagaWithOnEffect = applyOnEffect(onEffect, sagaWithCatch, model, key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'watcher'</span>:</span><br><span class="line">      <span class="keyword">return</span> sagaWithCatch;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'takeLatest'</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">yield</span> takeLatest(key, sagaWithOnEffect);</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'throttle'</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">yield</span> throttle(ms, key, sagaWithOnEffect);</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">yield</span> takeEvery(key, sagaWithOnEffect);</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到目前为止我们已经处理好了reduer与effects，接下来就是redux与redux-saga的初始化工作了<br>首先是redux<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = (app._store = createStore(&#123;</span><br><span class="line">  <span class="comment">// eslint-disable-line</span></span><br><span class="line">  reducers: createReducer(),</span><br><span class="line">  initialState: hooksAndOpts.initialState || &#123;&#125;,</span><br><span class="line">  plugin,</span><br><span class="line">  createOpts,</span><br><span class="line">  sagaMiddleware,</span><br><span class="line">  promiseMiddleware,</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>redux-saga<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sagas.forEach(sagaMiddleware.run);</span><br></pre></td></tr></table></figure></p>
<p>ola, dva的源码差不多就到这里了，再去看一个dva-loading是如何工作的。<br>先想一下dva-loading作用是监听effects的开始和结束,并把状态存在store里，那么他肯定需要一个reducer用来存储状态，和effect用来抛出action<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">    global: <span class="literal">false</span>,</span><br><span class="line">    models: &#123;&#125;,</span><br><span class="line">    effects: &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extraReducers = &#123;</span><br><span class="line">  [namespace](state = initialState, &#123; type, payload &#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; namespace, actionType &#125; = payload || &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> ret;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> SHOW:</span><br><span class="line">        ret = &#123;</span><br><span class="line">          ...state,</span><br><span class="line">          global: <span class="literal">true</span>,</span><br><span class="line">          models: &#123; ...state.models, [namespace]: <span class="literal">true</span> &#125;,</span><br><span class="line">          effects: &#123; ...state.effects, [actionType]: <span class="literal">true</span> &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> HIDE: <span class="comment">// eslint-disable-line</span></span><br><span class="line">        res = &#123;...&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        ret = state;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onEffect</span>(<span class="params">effect, &#123; put &#125;, model, actionType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; namespace &#125; = model;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">      (only.length === <span class="number">0</span> &amp;&amp; except.length === <span class="number">0</span>)</span><br><span class="line">      || (only.length &gt; <span class="number">0</span> &amp;&amp; only.indexOf(actionType) !== <span class="number">-1</span>)</span><br><span class="line">      || (except.length &gt; <span class="number">0</span> &amp;&amp; except.indexOf(actionType) === <span class="number">-1</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: SHOW, <span class="attr">payload</span>: &#123; namespace, actionType &#125; &#125;);</span><br><span class="line">          <span class="keyword">yield</span> effect(...args);</span><br><span class="line">          <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: HIDE, <span class="attr">payload</span>: &#123; namespace, actionType &#125; &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> effect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>onEffect在之前getWatcher中已经讲过，而extraReducers最后会通过combineReducers合并</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>dva的源码已经分析完了，看完这篇文章相信你已经对dva的工作方式有了大致的了解。下期我会分享react源码。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/06/dva-源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/06/dva-源码解析/" itemprop="url">dva-源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-06T09:45:12+08:00">
                2018-10-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="dva-cli"><a href="#dva-cli" class="headerlink" title="dva-cli"></a>dva-cli</h3><p>dva 的命令行工具<br>原理就是当运行 <code>dva new my-app</code> 时，dva-cli 就将其项目中的boilerplates文件夹拷贝到process.cwd()目录下。并且运行<code>npm install</code>安装项目依赖。</p>
<p>查看 package.json 入口在bin/dva<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Notify update when process exits</span></span><br><span class="line"><span class="keyword">const</span> updater = <span class="built_in">require</span>(<span class="string">'update-notifier'</span>);</span><br><span class="line"><span class="keyword">const</span> pkg = <span class="built_in">require</span>(<span class="string">'../package.json'</span>);</span><br><span class="line">updater(&#123; <span class="attr">pkg</span>: pkg &#125;).notify(&#123; <span class="attr">defer</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// dva -v</span></span><br><span class="line"><span class="keyword">if</span> (process.argv.slice(<span class="number">2</span>).join(<span class="string">''</span>) === <span class="string">'-v'</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">program</span><br><span class="line">  .usage(<span class="string">'&lt;command&gt; [options]'</span>)</span><br><span class="line">  .on(<span class="string">'--help'</span>, printHelp)</span><br><span class="line">  .parse(process.argv);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> aliases = &#123;</span><br><span class="line">  g: <span class="string">'generate'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> args = process.argv.slice(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// new、generate</span></span><br><span class="line"><span class="keyword">let</span> subcmd = program.args[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (aliases[subcmd]) subcmd = aliases[subcmd];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!subcmd) &#123;</span><br><span class="line">  program.help();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> bin = executable(subcmd);</span><br><span class="line">  <span class="keyword">if</span> (bin) &#123;</span><br><span class="line">    <span class="comment">// 执行文件</span></span><br><span class="line">    wrap(spawn(bin, args, &#123;<span class="attr">stdio</span>: <span class="string">'inherit'</span>, <span class="attr">customFds</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]&#125;));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    program.help();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrap</span>(<span class="params">sp</span>) </span>&#123;</span><br><span class="line">  sp.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">    process.exit(code);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是不是有相应 subcmd 的执行文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">executable</span>(<span class="params">subcmd</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> file = join(__dirname, <span class="string">'dva-'</span> + subcmd);</span><br><span class="line">  <span class="keyword">if</span> (exists(file)) &#123;</span><br><span class="line">    <span class="keyword">return</span> file;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>bin/dva 是dva-cli的入口文件，其中定义了-v命令以及执行相应的subcmd命令。如果你输入了<code>dva new my-app</code>，那么将会执行bin/dva-new,下面看下bin/dva-new文件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有定义项目名称</span></span><br><span class="line"><span class="keyword">if</span> (!program.args[<span class="number">0</span>]) &#123;</span><br><span class="line">  program.help();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> dest = join(process.cwd(), program.args[<span class="number">0</span>]);</span><br><span class="line">  <span class="comment">// 如果已经存在该项目</span></span><br><span class="line">  <span class="keyword">if</span> (existsSync(dest)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error(<span class="string">'Existing directory here, please run new command for an empty folder!'</span>));</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建目录</span></span><br><span class="line">  mkdirpSync(dest);</span><br><span class="line">  <span class="comment">// 进入目录</span></span><br><span class="line">  process.chdir(dest);</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'../lib/init'</span>)(program);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>bin/dva-new 检查了命令的有效性，并且创建、进入项目目录，执行dva-init初始化项目，下面去看一下bin/dva-init<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">program</span><br><span class="line">  .option(<span class="string">'--demo'</span>, <span class="string">'Generate dva project for demo'</span>)</span><br><span class="line">  .option(<span class="string">'--no-install'</span>, <span class="string">'Install dependencies after boilerplate, default: true'</span>)</span><br><span class="line">  .parse(process.argv);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../lib/init'</span>)(program);</span><br></pre></td></tr></table></figure></p>
<p>定义了两个配置项，然后又调用了lib/init，由于lib文件夹是打包出来的，先去看一下src/init文件吧<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">&#123; demo, install &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = demo ? <span class="string">'demo'</span> : <span class="string">'app'</span>;</span><br><span class="line">  <span class="comment">// __dirname 为执行文件所在的目录</span></span><br><span class="line">  <span class="keyword">const</span> cwd = join(__dirname, <span class="string">'../boilerplates'</span>, type);</span><br><span class="line">  <span class="keyword">const</span> dest = process.cwd();</span><br><span class="line">  <span class="keyword">const</span> projectName = basename(dest);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!emptyDir(dest)) &#123;</span><br><span class="line">    error(<span class="string">'Existing files here, please run init command in an empty folder!'</span>);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Creating a new Dva app in <span class="subst">$&#123;dest&#125;</span>.`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// vfs：文件流处理工具，将boilerplates中的文件拷贝到process.cwd目录下，</span></span><br><span class="line">  <span class="comment">// 如果install为true的话，则执行src/install</span></span><br><span class="line">  vfs.src([<span class="string">'**/*'</span>, <span class="string">'!node_modules/**/*'</span>], &#123;<span class="attr">cwd</span>: cwd, <span class="attr">cwdbase</span>: <span class="literal">true</span>, <span class="attr">dot</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    .pipe(template(dest, cwd))</span><br><span class="line">    .pipe(vfs.dest(dest))</span><br><span class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      info(<span class="string">'rename'</span>, <span class="string">'gitignore -&gt; .gitignore'</span>);</span><br><span class="line">      renameSync(join(dest, <span class="string">'gitignore'</span>), join(dest, <span class="string">'.gitignore'</span>));</span><br><span class="line">      <span class="keyword">if</span> (install) &#123;</span><br><span class="line">        info(<span class="string">'run'</span>, <span class="string">'npm install'</span>);</span><br><span class="line">        <span class="built_in">require</span>(<span class="string">'./install'</span>)(printSuccess);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        printSuccess();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .resume();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">printSuccess</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>src/install 会去根据系统安装的依赖管理工具进行install操作<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好吧 竟然没有yarn</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findNpm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> npms = process.platform === <span class="string">'win32'</span> ? [<span class="string">'tnpm.cmd'</span>, <span class="string">'cnpm.cmd'</span>, <span class="string">'npm.cmd'</span>] : [<span class="string">'tnpm'</span>, <span class="string">'cnpm'</span>, <span class="string">'npm'</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; npms.length; i++) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      which.sync(npms[i]);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'use npm: '</span> + npms[i]);</span><br><span class="line">      <span class="keyword">return</span> npms[i];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'please install npm'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> npm = findNpm();</span><br><span class="line">  <span class="comment">// 因为boilerplates/package.json 中没有dva，所以在运行install之后，再安装dva，why？</span></span><br><span class="line">  <span class="comment">// 为什么不干脆将dva写在boilerplates/package.json里呢，</span></span><br><span class="line">  <span class="comment">// 因为这样就可以保证每次安装的dva都是最新版本啊 骚年。</span></span><br><span class="line">  runCmd(which.sync(npm), [<span class="string">'install'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    runCmd(which.sync(npm), [<span class="string">'install'</span>, <span class="string">'dva'</span>, <span class="string">'--save'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(npm + <span class="string">' install end'</span>);</span><br><span class="line">      done();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>在上面我们已经分析了dva new的相关命令，其实dva还支持generate操作（文档上是这么说的），不过。。。我们来看下generate文件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="built_in">console</span>.log(chalk.red(<span class="string">'😢  dva generate is disabled since we don\'t have enough time currently.'</span>));</span><br><span class="line">process.exit(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../lib/generate'</span>)(program, &#123;</span><br><span class="line">  cwd: process.cwd(),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>四个字，暂未开放… 这个文档更新有点落后啊。dva-generate中又依赖了dva-ast 其中主要使用了 <code>facebook/jscodeshift</code>这个库，作用是解析js，将js内容解析成 AST 语法树，然后提供一些便利的操作接口，方便我们对各个节点进行更改，比如更改所有的属性名之类的。感兴趣的同学可以自己去研究一下，就送到这里啦～ dva-cli就分析到这里了，接下来我会去分析dva。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/26/数据结构与算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/26/数据结构与算法/" itemprop="url">数据结构与算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-26T22:55:28+08:00">
                2018-09-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h2><h3 id="为什么要进行复杂度分析"><a href="#为什么要进行复杂度分析" class="headerlink" title="为什么要进行复杂度分析"></a>为什么要进行复杂度分析</h3><ul>
<li>和性能测试相比，有不依赖执行环境、成本低、效率高的特点</li>
<li>掌握复杂度分析，将能编写出性能更高的代码，有利于降低系统开发和维护的成本</li>
</ul>
<h3 id="复杂度分析-1"><a href="#复杂度分析-1" class="headerlink" title="复杂度分析"></a>复杂度分析</h3><ul>
<li>时间复杂度： 不具体表示代码的真正的执行时间，而是表示代码执行时间随数据规模增长的变化趋势</li>
<li>空间复杂度： 代码所占空间随数据规模增长的变化趋势</li>
</ul>
<h4 id="时间复杂度分析"><a href="#时间复杂度分析" class="headerlink" title="时间复杂度分析"></a>时间复杂度分析</h4><ul>
<li><p>加法法则(总复杂度等于量级最大的那段代码的复杂度)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">    sum = sum + i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// var sum = 0; 为常量级的执行时间与n的大小无关</span></span><br><span class="line"><span class="comment">// for 循环 的两行代码需要执行n次，所以这个函数的时间复杂度为O(n)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>乘法法则(嵌套代码的复杂度等于嵌套内外代码的乘积)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cal</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt;= n; j++) &#123;</span><br><span class="line">      res = res + i + j;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// O(n * n) = O(n2)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="时间复杂度量级-从小到大"><a href="#时间复杂度量级-从小到大" class="headerlink" title="时间复杂度量级 从小到大"></a>时间复杂度量级 从小到大</h4><ul>
<li>O(1)</li>
<li>O(logn)</li>
<li>O(n)</li>
<li>O(nlogn) 归并排序 快速排序</li>
<li>O(n^2), O(n^3)…</li>
<li>O(2^n) 非多项式</li>
<li>O(n!) 非多项式</li>
</ul>
<h4 id="当有多个参数变化时，加法原则就不适用了，但乘法还是适用"><a href="#当有多个参数变化时，加法原则就不适用了，但乘法还是适用" class="headerlink" title="当有多个参数变化时，加法原则就不适用了，但乘法还是适用"></a>当有多个参数变化时，加法原则就不适用了，但乘法还是适用</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cal</span>(<span class="params">m, n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sum(m) + sum(n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 时间复杂度 O(m + n)</span></span><br></pre></td></tr></table></figure>
<h4 id="空间复杂度分析"><a href="#空间复杂度分析" class="headerlink" title="空间复杂度分析"></a>空间复杂度分析</h4><p>时间复杂度会了，空间复杂度很简单</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/26/redux-saga源码解析-下/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/26/redux-saga源码解析-下/" itemprop="url">redux-saga源码解析-下</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-26T07:34:54+08:00">
                2018-09-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇文中是对 <a href="">redux-saga源码解析</a> 的补充，可以帮助大家更加全面的了解redux-saga。主要探索一下 <strong>channel</strong>, 和redux-saga中的取消任务<br>想要具体分析一下channel并不是因为多么复杂，而是工作中可能会用到</p>
<h3 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h3><p>在前一篇文章中说到其实redux-saga支持三种channel，分别是channel， eventChannel， multicastChannel。multicastChannel 在前一篇文章已经分析过。这里就看一下另外两个。</p>
<h4 id="channel-1"><a href="#channel-1" class="headerlink" title="channel"></a>channel</h4><p>接受一个buffer对象，返回 channel 对象<br>buffer的作用：当没有任务监听器时，先把事件缓存起来，如果后面有新的任务监听器建立，就立即执行任务。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">channel</span>(<span class="params">buffer = buffers.expanding(</span>)) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> closed = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> takers = []</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果 channel 已经关闭，返回 </span></span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当没有任务监听器时， 缓存在 buffer 里</span></span><br><span class="line">    <span class="keyword">if</span> (takers.length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> buffer.put(input)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正常执行任务</span></span><br><span class="line">    <span class="keyword">const</span> cb = takers.shift()</span><br><span class="line">    cb(input)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">take</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果 channel 已经关闭并且buffer为空，则对任务发送END信号</span></span><br><span class="line">    <span class="comment">// 也可以看出来，即使 channel 关闭，buffer只要不为空，还是可以正常建立任务监听器的</span></span><br><span class="line">    <span class="keyword">if</span> (closed &amp;&amp; buffer.isEmpty()) &#123;</span><br><span class="line">      cb(END)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!buffer.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// buffer不为空的话 直接执行</span></span><br><span class="line">      cb(buffer.take())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 正常建立任务监听器</span></span><br><span class="line">      takers.push(cb)</span><br><span class="line">      cb.cancel = <span class="function"><span class="params">()</span> =&gt;</span> remove(takers, cb)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空buffer里的任务</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flush</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (closed &amp;&amp; buffer.isEmpty()) &#123;</span><br><span class="line">      cb(END)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    cb(buffer.flush())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当关闭channel时，终止所有任务监听器</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (!closed) &#123;</span><br><span class="line">      closed = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> (takers.length) &#123;</span><br><span class="line">        <span class="keyword">const</span> arr = takers</span><br><span class="line">        takers = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = arr.length; i &lt; len; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> taker = arr[i]</span><br><span class="line">          taker(END)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    take,</span><br><span class="line">    put,</span><br><span class="line">    flush,</span><br><span class="line">    close,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="eventChannel"><a href="#eventChannel" class="headerlink" title="eventChannel"></a>eventChannel</h4><p>eventChannel 是对 channel的封装，主要区别是 <strong>channel.put</strong> 函数交给subscribe函数驱动<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">eventChannel</span>(<span class="params">subscribe, buffer = buffers.none(</span>)) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> closed = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> unsubscribe</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> chan = channel(buffer)</span><br><span class="line">  <span class="keyword">const</span> close = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (is.func(unsubscribe)) &#123;</span><br><span class="line">      unsubscribe()</span><br><span class="line">    &#125;</span><br><span class="line">    chan.close()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unsubscribe = subscribe(<span class="function"><span class="params">input</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isEnd(input)) &#123;</span><br><span class="line">      close()</span><br><span class="line">      closed = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    chan.put(input)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is.func(unsubscribe)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'in eventChannel: subscribe should return a function to unsubscribe'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unsubscribe = once(unsubscribe)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">    unsubscribe()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    take: chan.take,</span><br><span class="line">    flush: chan.flush,</span><br><span class="line">    close,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>example:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个channel刚建立就被关闭了</span></span><br><span class="line">eventChannel(<span class="function"><span class="params">emitter</span> =&gt;</span> &#123;</span><br><span class="line">  emitter(END)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="cancel"><a href="#cancel" class="headerlink" title="cancel"></a>cancel</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">test</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">yield</span> call(delayUtil, <span class="number">5000</span>);</span><br><span class="line">    <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">text</span>: action.text  &#125;);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">yield</span> cancelled()) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'cancelled'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> action = <span class="keyword">yield</span> take(<span class="string">'ADD_TODO_SAGA'</span>);</span><br><span class="line">  <span class="keyword">const</span> task = <span class="keyword">yield</span> fork(test, action);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">yield</span> call(delayUtil, <span class="number">4000</span>);</span><br><span class="line">  <span class="keyword">yield</span> cancel(task);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sagaMiddleware.run(rootSaga)</span><br></pre></td></tr></table></figure>
<p>这里首先监听了ADD_TODO_SAGA事件，在4s之后又取消了任务，由于在子任务中延时了5s，所以 ADD_TODO 并没有被抛出。</p>
<h4 id="cancel-effect"><a href="#cancel-effect" class="headerlink" title="cancel effect"></a>cancel effect</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cancelSingleTask</span>(<span class="params">taskToCancel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (taskToCancel.isRunning()) &#123;</span><br><span class="line">    taskToCancel.cancel()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到调用task的cancel方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cancel</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (task._isRunning &amp;&amp; !task._isCancelled) &#123;</span><br><span class="line">    task._isCancelled = <span class="literal">true</span></span><br><span class="line">    taskQueue.cancelAll()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际执行的就是 taskQueue.cancelAll() 在这里取消了任务及其子任务。</p>
<h4 id="cancelled-effect"><a href="#cancelled-effect" class="headerlink" title="cancelled effect"></a>cancelled effect</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runCancelledEffect</span>(<span class="params">data, cb</span>) </span>&#123;</span><br><span class="line">  cb(<span class="built_in">Boolean</span>(mainTask._isCancelled))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接将_isCancelled作为结果</p>
<p>由于取消任务是在父线程上作的，所以应该通知到子线程上。<br>原理是当迭代器运行return方法时，<code>iterator.return()</code> 函数就会跳过try剩下的语句，直接进入finally代码块。这里改造一下之前的自动流程控制demo<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> delay = <span class="function">(<span class="params">ms</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(res, ms);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'begin'</span>);</span><br><span class="line">    <span class="keyword">yield</span> delay(<span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1s later'</span>);</span><br><span class="line">    <span class="keyword">yield</span> delay(<span class="number">2000</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'end'</span>);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finally'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autoRun</span>(<span class="params">gfunc</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> gen = gfunc();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = gen.next();</span><br><span class="line">    gen.return(<span class="string">'cancel'</span>);</span><br><span class="line">    <span class="keyword">if</span> (res.done) <span class="keyword">return</span>;</span><br><span class="line">    res.value.then(next);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">autoRun(main);</span><br><span class="line"><span class="comment">// begin</span></span><br><span class="line"><span class="comment">// finish</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到直接进入了finally代码块。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这边文章主要是对前一篇文章的补充，探索了一下我比较感兴趣的两个点，也希望读者看完之后会有所帮助。<br>接下来我会分析一下dva（基于 redux、redux-saga 和 react-router 的轻量级前端框架）</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/09/redux-saga源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/09/redux-saga源码解析/" itemprop="url">redux-saga源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-09T16:28:49+08:00">
                2018-09-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Redux-saga是redux应用的又一个副作用模型。可以用来替换redux-thunk中间件。<br>redux-saga 抽象出 <strong>Effect</strong> （影响, 例如等待action、发出action、fetch数据等等），便于组合与测试。</p>
<p>我想在分析redux-saga之前，先来看看redux-thunk是怎么一回事<br>redux 在我之前一篇文章中讲过了<a href="https://juejin.im/post/5b94962f6fb9a05cf908127a" target="_blank" rel="noopener">链接</a><br>那我们就先用 <strong>redux-thunk</strong> 来写一个 asyncTodo 的demo</p>
<h3 id="redux-thunk-分析"><a href="#redux-thunk-分析" class="headerlink" title="redux-thunk 分析"></a>redux-thunk 分析</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">const</span> thunk = <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> action(dispatch, getState);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> next(action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = <span class="function">(<span class="params">&#123; getState &#125;</span>) =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'will dispatch'</span>, getState());</span><br><span class="line">  next(action)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'state after dispatch'</span>, getState());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todos = <span class="function">(<span class="params">state = [], action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        ...state,</span><br><span class="line">        action.text</span><br><span class="line">      ];</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  todos,</span><br><span class="line">  [<span class="string">'Use Redux'</span>],</span><br><span class="line">  applyMiddleware(logger, thunk),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">store.dispatch(<span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">text</span>: <span class="string">'Read the docs'</span> &#125;);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>原本redux中action只能是 <strong>plain object</strong> ，redux-thunk使action可以为function。当我们想抛出一个异步的action时，其实我们是把异步的处理放在了actionCreator中。<br>这样就会导致action形式不统一，并且对于异步的处理将会分散到各个action中，不利于维护。<br>接下来看看redux-saga是如何实现的</p>
<h3 id="redux-saga"><a href="#redux-saga" class="headerlink" title="redux-saga"></a>redux-saga</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> createSagaMiddleware <span class="keyword">from</span> <span class="string">'redux-saga'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; put, take, fork, delay &#125; <span class="keyword">from</span> <span class="string">'./redux-saga/effects'</span></span><br><span class="line"><span class="keyword">import</span> &#123; delay <span class="keyword">as</span> delayUtil &#125; <span class="keyword">from</span> <span class="string">'redux-saga/utils'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取redux中间件</span></span><br><span class="line"><span class="keyword">const</span> sagaMiddleware = createSagaMiddleware(&#123;</span><br><span class="line">  sagaMonitor: &#123;</span><br><span class="line">    <span class="comment">// 打印 effect 便于分析redux-saga行为</span></span><br><span class="line">    effectTriggered(options) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(options);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> action = <span class="keyword">yield</span> take(<span class="string">'ADD_TODO_SAGA'</span>);</span><br><span class="line">  <span class="comment">// delay(): &#123; type: 'call', payload: &#123; args: [1000], fn &#125;&#125;</span></span><br><span class="line">  <span class="keyword">yield</span> delay(<span class="number">1000</span>); <span class="comment">// or yield call(delayUtil, 1000)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// put(): &#123; type: 'PUT', payload: &#123; action: &#123;&#125;, channel: null &#125;&#125;</span></span><br><span class="line">  <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">text</span>: action.text  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  todos,</span><br><span class="line">  [<span class="string">'Use Redux'</span>],</span><br><span class="line">  applyMiddleware(logger, sagaMiddleware),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动saga</span></span><br><span class="line">sagaMiddleware.run(rootSaga);</span><br><span class="line"></span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'ADD_TODO_SAGA'</span>, <span class="attr">text</span>: <span class="string">'Use Redux-saga'</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>可以看到这里抛出的就是一个纯action， saga在启动之后监听 <strong>ADD_TODO_SAGA</strong> 事件，若事件发生执行后续代码。</p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><h4 id="stdChannel"><a href="#stdChannel" class="headerlink" title="stdChannel"></a>stdChannel</h4><p>在开始createSagaMiddleware之前，先来了解一下 <strong>channel</strong><br>redux-saga 通过 channel 接收与发出action与外部进行数据交换<br>在redux-saga中有三种 channel，分别是channel、eventChannel、multicastChannel；<br>在此我们仅仅分析一下用的最多的 multicastChannel<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">multicastChannel</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> closed = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// 这里taker分为的currentTakers、 nextTakers的原因和redux subscribe类似，防止在遍历taker时，taker发生变化。</span></span><br><span class="line">  <span class="keyword">let</span> currentTakers = []</span><br><span class="line">  <span class="keyword">let</span> nextTakers = currentTakers</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ensureCanMutateNextTakers = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextTakers !== currentTakers) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextTakers = currentTakers.slice()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> close = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    closed = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> takers = (currentTakers = nextTakers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; takers.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> taker = takers[i]</span><br><span class="line">      taker(END)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextTakers = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    [MULTICAST]: <span class="literal">true</span>,</span><br><span class="line">    put(input) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isEnd(input)) &#123;</span><br><span class="line">        close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> takers = (currentTakers = nextTakers)</span><br><span class="line">      <span class="comment">// 遍历takers，找到与input匹配的taker并执行它。</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; takers.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> taker = takers[i]</span><br><span class="line">        <span class="keyword">if</span> (taker[MATCH](input)) &#123;</span><br><span class="line">          taker.cancel()</span><br><span class="line">          taker(input)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 存下callback，与配置函数</span></span><br><span class="line">    take(cb, matcher = matchers.wildcard) &#123;</span><br><span class="line">      <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">        cb(END)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      cb[MATCH] = matcher</span><br><span class="line">      ensureCanMutateNextTakers()</span><br><span class="line">      nextTakers.push(cb)</span><br><span class="line"></span><br><span class="line">      cb.cancel = once(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        ensureCanMutateNextTakers()</span><br><span class="line">        remove(nextTakers, cb)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    close,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">stdChannel</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> chan = multicastChannel()</span><br><span class="line">  <span class="keyword">const</span> &#123; put &#125; = chan</span><br><span class="line">  chan.put = <span class="function"><span class="params">input</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input[SAGA_ACTION]) &#123;</span><br><span class="line">      put(input)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 暂时不用管</span></span><br><span class="line">    asap(<span class="function"><span class="params">()</span> =&gt;</span> put(input))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> chan</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="createSagaMiddleware"><a href="#createSagaMiddleware" class="headerlink" title="createSagaMiddleware"></a>createSagaMiddleware</h4><p>获取redux-middleware， 同时初始化runsaga函数，为后面启动saga bind 所需的参数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">sagaMiddlewareFactory</span>(<span class="params">&#123; context = &#123;&#125;, ...options &#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; sagaMonitor, logger, onError, effectMiddlewares &#125; = options</span><br><span class="line">  <span class="keyword">let</span> boundRunSaga</span><br><span class="line"></span><br><span class="line">  <span class="comment">// redux middleware</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sagaMiddleware</span>(<span class="params">&#123; getState, dispatch &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 新建一个channel</span></span><br><span class="line">    <span class="keyword">const</span> channel = stdChannel()</span><br><span class="line">    channel.put = (options.emitter || identity)(channel.put)</span><br><span class="line"></span><br><span class="line">    boundRunSaga = runSaga.bind(<span class="literal">null</span>, &#123;</span><br><span class="line">      context,</span><br><span class="line">      channel,</span><br><span class="line">      dispatch,</span><br><span class="line">      getState,</span><br><span class="line">      sagaMonitor,</span><br><span class="line">      logger,</span><br><span class="line">      onError,</span><br><span class="line">      effectMiddlewares,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> action =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (sagaMonitor &amp;&amp; sagaMonitor.actionDispatched) &#123;</span><br><span class="line">        sagaMonitor.actionDispatched(action)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> result = next(action) <span class="comment">// hit reducers</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将事件传递给saga</span></span><br><span class="line">      channel.put(action)</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动saga</span></span><br><span class="line">  sagaMiddleware.run = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> boundRunSaga(...args)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sagaMiddleware</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="runsaga"><a href="#runsaga" class="headerlink" title="runsaga"></a>runsaga</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runSaga</span>(<span class="params">options, saga, ...args</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// generate iterator</span></span><br><span class="line">  <span class="keyword">const</span> iterator = saga(...args)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    channel = stdChannel(),</span><br><span class="line">    dispatch,</span><br><span class="line">    getState,</span><br><span class="line">    context = &#123;&#125;,</span><br><span class="line">    sagaMonitor,</span><br><span class="line">    logger,</span><br><span class="line">    effectMiddlewares,</span><br><span class="line">    onError,</span><br><span class="line">  &#125; = options</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> effectId = nextSagaId()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一些错误检查</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> log = logger || _log</span><br><span class="line">  <span class="keyword">const</span> logError = <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    log(<span class="string">'error'</span>, err)</span><br><span class="line">    <span class="keyword">if</span> (err &amp;&amp; err.sagaStack) &#123;</span><br><span class="line">      log(<span class="string">'error'</span>, err.sagaStack)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> middleware = effectMiddlewares &amp;&amp; compose(...effectMiddlewares)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可以先理解为 finalizeRunEffect = runEffect =&gt; runEffect</span></span><br><span class="line">  <span class="keyword">const</span> finalizeRunEffect = <span class="function"><span class="params">runEffect</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (is.func(middleware)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">finalRunEffect</span>(<span class="params">effect, effectId, currCb</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> plainRunEffect = <span class="function"><span class="params">eff</span> =&gt;</span> runEffect(eff, effectId, currCb)</span><br><span class="line">        <span class="keyword">return</span> middleware(plainRunEffect)(effect)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> runEffect</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> env = &#123;</span><br><span class="line">    stdChannel: channel,</span><br><span class="line">    dispatch: wrapSagaDispatch(dispatch),</span><br><span class="line">    getState,</span><br><span class="line">    sagaMonitor,</span><br><span class="line">    logError,</span><br><span class="line">    onError,</span><br><span class="line">    finalizeRunEffect,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 新建task，作用是控制 Generator 流程，类似与自动流程管理，这个后面会讲到</span></span><br><span class="line">  <span class="keyword">const</span> task = proc(env, iterator, context, effectId, getMetaInfo(saga), <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> task</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>redux-saga的核心就是task, 控制generator函数saga执行流程。是一个复杂的自动流程管理，我们先看一个简单的自动流程管理<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个返回promise的delay函数</span></span><br><span class="line"><span class="keyword">const</span> delay = <span class="function">(<span class="params">ms</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(res, ms);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> delay(<span class="number">1000</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'1s later'</span>);</span><br><span class="line">  <span class="keyword">yield</span> delay(<span class="number">2000</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'done'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了达到想要的执行结果，我们必须在promise resolved之后再执行next statement，比如这样</span></span><br><span class="line"><span class="keyword">const</span> gen = main();</span><br><span class="line"><span class="keyword">const</span> r1 = gen.next();</span><br><span class="line">r1.value.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> r2 = gen.next();</span><br><span class="line">  r2.value.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    gen.next();</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>使用递归实现，自动流程控制<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autoRun</span>(<span class="params">gfunc</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> gen = gfunc();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = gen.next();</span><br><span class="line">    <span class="keyword">if</span> (res.done) <span class="keyword">return</span>;</span><br><span class="line">    res.value.then(next);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line">autoRun(main);</span><br></pre></td></tr></table></figure></p>
<p>上面的自动流程控制函数仅仅支持 promise。</p>
<h4 id="proc"><a href="#proc" class="headerlink" title="proc"></a>proc</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">proc</span>(<span class="params">env, iterator, parentContext, parentEffectId, meta, cont</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> task = newTask(parentEffectId, meta, cont)</span><br><span class="line">  <span class="keyword">const</span> mainTask = &#123; meta, <span class="attr">cancel</span>: cancelMain, <span class="attr">_isRunning</span>: <span class="literal">true</span>, <span class="attr">_isCancelled</span>: <span class="literal">false</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 task tree</span></span><br><span class="line">  <span class="keyword">const</span> taskQueue = forkQueue(</span><br><span class="line">    mainTask,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onAbort</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      cancelledDueToErrorTasks.push(...taskQueue.getTaskNames())</span><br><span class="line">    &#125;,</span><br><span class="line">    end,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  next()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// then return the task descriptor to the caller</span></span><br><span class="line">  <span class="keyword">return</span> task</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">arg, isErr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> result</span><br><span class="line">    <span class="keyword">if</span> (isErr) &#123;</span><br><span class="line">      result = iterator.throw(arg)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldCancel(arg)) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldTerminate(arg)) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = iterator.next(arg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result.done) &#123;</span><br><span class="line">      <span class="comment">// 如果没结束, 执行相应 effect</span></span><br><span class="line">      digestEffect(result.value, parentEffectId, <span class="string">''</span>, next)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">        This Generator has ended, terminate the main task and notify the fork queue</span></span><br><span class="line"><span class="comment">      **/</span></span><br><span class="line">      mainTask._isRunning = <span class="literal">false</span></span><br><span class="line">      mainTask.cont(result.value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">digestEffect</span>(<span class="params">effect, parentEffectId, label = <span class="string">''</span>, cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 封装了cb函数 增加了事件钩子</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">currCb</span>(<span class="params">res, isErr</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (effectSettled) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      effectSettled = <span class="literal">true</span></span><br><span class="line">      cb.cancel = noop <span class="comment">// defensive measure</span></span><br><span class="line">      <span class="keyword">if</span> (env.sagaMonitor) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isErr) &#123;</span><br><span class="line">          env.sagaMonitor.effectRejected(effectId, res)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          env.sagaMonitor.effectResolved(effectId, res)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isErr) &#123;</span><br><span class="line">        crashedEffect = effect</span><br><span class="line">      &#125;</span><br><span class="line">      cb(res, isErr)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runEffect(effect, effectId, currCb)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每个 effect 的执行函数 这里先看一下常用的几个effect</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">runEffect</span>(<span class="params">effect, effectId, currCb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is.promise(effect)) &#123;</span><br><span class="line">      resolvePromise(effect, currCb)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is.iterator(effect)) &#123;</span><br><span class="line">      resolveIterator(effect, effectId, meta, currCb)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (effect &amp;&amp; effect[IO]) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; type, payload &#125; = effect</span><br><span class="line">      <span class="keyword">if</span> (type === effectTypes.TAKE) runTakeEffect(payload, currCb)</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (type === effectTypes.PUT) runPutEffect(payload, currCb)</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (type === effectTypes.CALL) runCallEffect(payload, effectId, currCb)</span><br><span class="line">      <span class="comment">// 其他所有的effect ...</span></span><br><span class="line">      <span class="keyword">else</span> currCb(effect)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// anything else returned as is</span></span><br><span class="line">      currCb(effect)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当返回值是 promise 时，就和之前实现的自动进程控制函数一样嘛</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span>(<span class="params">promise, cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    promise.then(cb, error =&gt; cb(error, <span class="literal">true</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当是generator函数时</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">resolveIterator</span>(<span class="params">iterator, effectId, meta, cb</span>) </span>&#123;</span><br><span class="line">    proc(env, iterator, taskContext, effectId, meta, cb)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当是 take 就把callback放在channel里，如果有匹配事件发生，触发 callback</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">runTakeEffect</span>(<span class="params">&#123; channel = env.stdChannel, pattern, maybe &#125;, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> takeCb = <span class="function"><span class="params">input</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (input <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">        cb(input, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isEnd(input) &amp;&amp; !maybe) &#123;</span><br><span class="line">        cb(TERMINATE)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      cb(input)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      channel.take(takeCb, is.notUndef(pattern) ? matcher(pattern) : <span class="literal">null</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      cb(err, <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    cb.cancel = takeCb.cancel</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">runPutEffect</span>(<span class="params">&#123; channel, action, resolve &#125;, cb</span>) </span>&#123;</span><br><span class="line">    asap(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> result</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 发送 action</span></span><br><span class="line">        result = (channel ? channel.put : env.dispatch)(action)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        cb(error, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (resolve &amp;&amp; is.promise(result)) &#123;</span><br><span class="line">        resolvePromise(result, cb)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cb(result)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// put 是不能取消的</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">runCallEffect</span>(<span class="params">&#123; context, fn, args &#125;, effectId, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = fn.apply(context, args)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      cb(error, <span class="literal">true</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> is.promise(result)</span><br><span class="line">      ? resolvePromise(result, cb)</span><br><span class="line">      : is.iterator(result)</span><br><span class="line">        ? resolveIterator(result, effectId, getMetaInfo(fn), cb)</span><br><span class="line">        : cb(result)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>redux-saga 将异步操作抽象为 effect，利用 generator 函数，控制saga流程。<br>到目前为止，只是涉及了一些基本流程，下一篇会对本篇进行补充。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/03/redux源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/03/redux源码分析/" itemprop="url">redux源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-03T23:07:02+08:00">
                2018-09-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>Redux is a predictable state container for JavaScript apps.</code><br>官网第一句就很全面的介绍了redux。一个可预测的状态管理工具。redux 是如何做到的呢？</p>
<ul>
<li>单一的数据源 (states)</li>
<li>states是只读且不可变化的 (每次改变返回新值)</li>
<li>通过纯函数改变states (reducer, 无副作用, 相同的输入就有相同的输出)</li>
<li>改变states方式具有可描述性且单一 (action)</li>
</ul>
<h3 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h3><p><img src="/images/redux.gif" alt=""><br>这个大家都很熟悉了吧，就不再讲了</p>
<h3 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h3><h4 id="createStore"><a href="#createStore" class="headerlink" title="createStore"></a>createStore</h4><p><code>func createStore(reducer, preloadedState, enhancer) -&gt; ({ dispatch, subscribe, getState, replaceReducer,[$$observable]: observable })</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// preloadedState 可以不传，确定真实的参数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    enhancer = preloadedState</span><br><span class="line">    preloadedState = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> currentReducer = reducer</span><br><span class="line">  <span class="keyword">let</span> currentState = preloadedState</span><br><span class="line">  <span class="keyword">let</span> currentListeners = []</span><br><span class="line">  <span class="keyword">let</span> nextListeners = currentListeners</span><br><span class="line">  <span class="keyword">let</span> isDispatching = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ensureCanMutateNextListeners</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.slice()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    ensureCanMutateNextListeners()</span><br><span class="line">    nextListeners.push(listener)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      ensureCanMutateNextListeners()</span><br><span class="line">      <span class="keyword">const</span> index = nextListeners.indexOf(listener)</span><br><span class="line">      nextListeners.splice(index, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span></span><br><span class="line">      currentState = currentReducer(currentState, action)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> listeners = (currentListeners = nextListeners)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">      listener()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: ActionTypes.REPLACE &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">observable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer,</span><br><span class="line">    [$$observable]: observable,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了篇幅减少些，上面的代码我删掉了部分错误检查。其实都很好理解，就有一点需要注意一下，为什么要用两个变量（currentListeners，nextListeners）来储存listener。这是因为redux允许在subscirbe中执行unsubscribe。<br>例如:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unsubscribe1 = store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  unsubscribe1()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> unsubscribe2 = store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  unsubscribe2()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">dispatch(unknownAction);</span><br></pre></td></tr></table></figure></p>
<p>如果不缓存dispatch的listener的话 那么在dispatch里循环listeners时就会有问题。<br>另外也可以发现，如果你绑定了多个subscribe函数，即使在第一个subscription里执行了所有的unSubscribe，subscription还是会全部执行一遍<br>另外 <code>observable</code> 是为了和其他一些observable库配合使用，当目前为止还没用过。</p>
<h4 id="applyMiddleware"><a href="#applyMiddleware" class="headerlink" title="applyMiddleware"></a>applyMiddleware</h4><h5 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="function">(<span class="params">&#123; getState &#125;</span>) =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'will dispatch logger1'</span>, action)</span><br><span class="line">  <span class="keyword">const</span> returnValue = next(action)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'state after dispatch logger1'</span>, getState())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger2 = <span class="function">(<span class="params">&#123; getState &#125;</span>) =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'will dispatch logger2'</span>, action)</span><br><span class="line">  <span class="keyword">const</span> returnValue = next(action)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'state after dispatch logger2'</span>, getState())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  todos,</span><br><span class="line">  preload,</span><br><span class="line">  applyMiddleware(logger1, logger2),</span><br><span class="line">);</span><br><span class="line"><span class="comment">// will dispatch logger1</span></span><br><span class="line"><span class="comment">// will dispatch logger2</span></span><br><span class="line"><span class="comment">// state after dispatch logger2</span></span><br><span class="line"><span class="comment">// state after dispatch logger1</span></span><br></pre></td></tr></table></figure>
<h5 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">createStore</span> =&gt;</span> (...args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> store = createStore(...args)</span><br><span class="line">    <span class="keyword">let</span> dispatch = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`Dispatching while constructing your middleware is not allowed. `</span> +</span><br><span class="line">          <span class="string">`Other middleware would not be applied to this dispatch.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// chainItem：next =&gt; action =&gt; &#123;...&#125;</span></span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> (...args) =&gt; a(b(...args)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compose(logger1, logger2) =&gt; (...arg) =&gt; logger1Next(logger2Next(...arg))</span></span><br><span class="line"><span class="comment">// 合成之后的dispatch就成了这个样子：</span></span><br><span class="line"><span class="keyword">const</span> dispatch = <span class="function">(<span class="params">action</span>) =&gt;</span> logger1Next(logger2Next(store.dispatch))(action);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假如还有logger3， 那么应该是这个样子</span></span><br><span class="line"><span class="keyword">const</span> dispatch = <span class="function">(<span class="params">action</span>) =&gt;</span> logger1Next(logger2Next(logger3Next(store.dispatch)))(action);</span><br></pre></td></tr></table></figure>
<p>可以compose原因是middle模式统一：store =&gt; next =&gt; action =&gt; {}<br>在执行完 const chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))之后<br>chainItem: next =&gt; action =&gt; {} 本质是  <code>接收一个dispatch，再返回一个合成的dispatch</code></p>
<h4 id="bindActionCreators"><a href="#bindActionCreators" class="headerlink" title="bindActionCreators"></a>bindActionCreators</h4><h5 id="用法-1"><a href="#用法-1" class="headerlink" title="用法"></a>用法</h5><p>bindActionCreators({ actionCreator1, actionCreator2, …}, dispatch) =&gt; ({ boundAction1, boundAction2, … })</p>
<h5 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回 boundAction</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch(actionCreator.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 仅仅传入一个actionCreator</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> bindActionCreator(actionCreators, dispatch)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators !== <span class="string">'object'</span> || actionCreators === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 传入一个对象时，绑定所有key，并返回一个对象</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</span><br><span class="line">  <span class="keyword">const</span> boundActionCreators = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="keyword">const</span> actionCreator = actionCreators[key]</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</span><br><span class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> boundActionCreators</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="combineReducers"><a href="#combineReducers" class="headerlink" title="combineReducers"></a>combineReducers</h4><p>由于redux仅有一个store，所以当项目复杂的时候，数据需要分类，这时就会用到此函数。作用是将多个分开的reducers合并。</p>
<p>原型：（reducer1，reducer2， reducer3，…） =&gt; combinedReducer<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">  <span class="comment">// 遍历检查 reducer 不应该为 undefined</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = reducerKeys[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        warning(<span class="string">`No reducer provided for key "<span class="subst">$&#123;key&#125;</span>"`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unexpectedKeyCache</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    unexpectedKeyCache = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> shapeAssertionError</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 检查 reducer 必须设置初始值，不可以返回 undefined</span></span><br><span class="line">    assertReducerShape(finalReducers)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    shapeAssertionError = e</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// combinedReducer</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shapeAssertionError) &#123;</span><br><span class="line">      <span class="keyword">throw</span> shapeAssertionError</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="comment">// 检查 state 是否合法，例如state必须是对象、state应该有相对应的reducer等</span></span><br><span class="line">      <span class="comment">// 使用了combineRudcer之后，state就是对象了，原来的state都放在了相对应的key下面</span></span><br><span class="line">      <span class="comment">// 例如：combineReducers(&#123; todos: reducer1, todoType: reducer2 &#125;);</span></span><br><span class="line">      <span class="comment">// store 变成了 &#123; todos: todoState, todoType: todoTypeState &#125;;</span></span><br><span class="line">      <span class="keyword">const</span> warningMessage = getUnexpectedStateShapeWarningMessage(</span><br><span class="line">        state,</span><br><span class="line">        finalReducers,</span><br><span class="line">        action,</span><br><span class="line">        unexpectedKeyCache</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (warningMessage) &#123;</span><br><span class="line">        warning(warningMessage)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">    <span class="comment">// 将action分发给每个reducer， 如果该改变就返回新的。</span></span><br><span class="line">    <span class="comment">// 否则返回旧值，类似于你在每个reduer中的做法。</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]</span><br><span class="line">      <span class="keyword">const</span> reducer = finalReducers[key]</span><br><span class="line">      <span class="keyword">const</span> previousStateForKey = state[key]</span><br><span class="line">      <span class="keyword">const</span> nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> errorMessage = getUndefinedStateErrorMessage(key, action)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(errorMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      nextState[key] = nextStateForKey</span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>redux源码还是比较好理解的，记住reducer一定要保证是纯函数。这对于测试和与其他的库配合至关重要。例如 react-redux。<br>感兴趣的朋友可以看看我的react-redux源码分析</p>
<ul>
<li><a href="https://juejin.im/post/5b8b5a60e51d4538c411ff12" target="_blank" rel="noopener">react-redux源码分析及实现原型</a></li>
<li><a href="https://juejin.im/post/5b8baa06e51d45388c445f5d" target="_blank" rel="noopener">react-redux源码分析及实现原型（下）</a><br>下周会给大家带来redux-saga这个中间件源码解读，感兴趣的请关注～</li>
</ul>
<h3 id="参考阅读"><a href="#参考阅读" class="headerlink" title="参考阅读"></a>参考阅读</h3><p><a href="https://blog.gisspan.com/2017/02/Redux-Vs-MVC,-Why-and-How.html" target="_blank" rel="noopener">https://blog.gisspan.com/2017/02/Redux-Vs-MVC,-Why-and-How.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/02/react-redux源码分析及实现原型-下/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/02/react-redux源码分析及实现原型-下/" itemprop="url">react-redux源码分析及实现原型_下</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-02T12:21:55+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一次我们讲解了Provider、connect、selectorFactory。这次主要分析 connectAdvanced 这个核心API。</p>
<h3 id="connectAdvanced"><a href="#connectAdvanced" class="headerlink" title="connectAdvanced"></a>connectAdvanced</h3><p>在开始之前我们先来看一个工具函数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeSelectorStateful</span>(<span class="params">sourceSelector, store</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> selector = &#123;</span><br><span class="line">    run: <span class="function"><span class="keyword">function</span> <span class="title">runComponentSelector</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> nextProps = sourceSelector(store.getState(), props)</span><br><span class="line">        <span class="keyword">if</span> (nextProps !== selector.props || selector.error) &#123;</span><br><span class="line">          selector.shouldComponentUpdate = <span class="literal">true</span></span><br><span class="line">          selector.props = nextProps</span><br><span class="line">          selector.error = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        selector.shouldComponentUpdate = <span class="literal">true</span></span><br><span class="line">        selector.error = error</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> selector</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上篇讲过 selector 会将新的值和缓存的值做比较，如果变化，将重新求值并返回，如果没变化，返回缓存的旧值。makeSelectorStateful 函数是对 selector 的封装。正如其名字一样，使selector stateful</p>
<p>再介绍一下<code>hoist-non-react-statics</code>这个库，作用是避免在使用HOC时，导致类的static方法丢失的问题。详情见<a href="https://reactjs.org/docs/higher-order-components.html#static-methods-must-be-copied-over" target="_blank" rel="noopener">react doc</a></p>
<p><code>Subscription</code>是实现react与redux绑定的类，在接下来会用到我们先来看一下<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Subscription</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(store, parentSub, onStateChange) &#123;</span><br><span class="line">    <span class="keyword">this</span>.store = store</span><br><span class="line">    <span class="keyword">this</span>.parentSub = parentSub</span><br><span class="line">    <span class="keyword">this</span>.onStateChange = onStateChange</span><br><span class="line">    <span class="keyword">this</span>.unsubscribe = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.listeners = nullListeners</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addNestedSub(listener) &#123;</span><br><span class="line">    <span class="keyword">this</span>.trySubscribe()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.listeners.subscribe(listener)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notifyNestedSubs() &#123;</span><br><span class="line">    <span class="keyword">this</span>.listeners.notify()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isSubscribed() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Boolean</span>(<span class="keyword">this</span>.unsubscribe)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  trySubscribe() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.unsubscribe) &#123;</span><br><span class="line">      <span class="keyword">this</span>.unsubscribe = <span class="keyword">this</span>.parentSub</span><br><span class="line">        ? <span class="keyword">this</span>.parentSub.addNestedSub(<span class="keyword">this</span>.onStateChange)</span><br><span class="line">        : <span class="keyword">this</span>.store.subscribe(<span class="keyword">this</span>.onStateChange)</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">this</span>.listeners = createListenerCollection()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tryUnsubscribe() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.unsubscribe) &#123;</span><br><span class="line">      <span class="keyword">this</span>.unsubscribe()</span><br><span class="line">      <span class="keyword">this</span>.unsubscribe = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">this</span>.listeners.clear()</span><br><span class="line">      <span class="keyword">this</span>.listeners = nullListeners</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重点在 trySubscribe 方法，如果 parentSub 存在就将回调函数绑定在父组件上，否则绑定在store.subscribe中<br>原因是这样可以保证组件的更新顺序，从父到子。</p>
<p>然后可以开始 <code>connectAdvanced</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connectAdvanced</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  selectorFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    shouldHandleStateChanges = true,</span></span></span><br><span class="line"><span class="function"><span class="params">    storeKey = <span class="string">'store'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> 传递给 selectorFactory 的参数</span></span></span><br><span class="line"><span class="function"><span class="params">    ...connectOptions</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125; = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> selectorFactoryOptions = &#123;</span><br><span class="line">      ...connectOptions,</span><br><span class="line">      shouldHandleStateChanges,</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">      <span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props, context)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.version = version</span><br><span class="line">        <span class="keyword">this</span>.state = &#123;&#125;</span><br><span class="line">        <span class="keyword">this</span>.renderCount = <span class="number">0</span></span><br><span class="line">        <span class="keyword">this</span>.store = props[storeKey] || context[storeKey]</span><br><span class="line">        <span class="keyword">this</span>.propsMode = <span class="built_in">Boolean</span>(props[storeKey])</span><br><span class="line">        <span class="keyword">this</span>.setWrappedInstance = <span class="keyword">this</span>.setWrappedInstance.bind(<span class="keyword">this</span>)、</span><br><span class="line"></span><br><span class="line">        <span class="comment">// selector 与 subscription 的初始化</span></span><br><span class="line">        <span class="keyword">this</span>.initSelector()</span><br><span class="line">        <span class="keyword">this</span>.initSubscription()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      getChildContext() &#123;</span><br><span class="line">        <span class="comment">// 如果组件从props里获得store，那么将 context 中的 subscription 传递下去</span></span><br><span class="line">        <span class="comment">// 否则就将传递此组件中的 subscription</span></span><br><span class="line">        <span class="comment">// 子组件使用祖先组件的 subscription 可以保证组件的更新顺序（父 -&gt; 子）。</span></span><br><span class="line">        <span class="comment">// 另外 将store通过props传递下去，这种场景是什么。。。</span></span><br><span class="line">        <span class="keyword">const</span> subscription = <span class="keyword">this</span>.propsMode ? <span class="literal">null</span> : <span class="keyword">this</span>.subscription</span><br><span class="line">        <span class="keyword">return</span> &#123; [subscriptionKey]: subscription || <span class="keyword">this</span>.context[subscriptionKey] &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      componentDidMount() &#123;</span><br><span class="line">        <span class="comment">// shouldHandleStateChanges === Boolean(mapStateToProps)</span></span><br><span class="line">        <span class="comment">// 如果没有 mapStateToProps 组件不需要监听store变化</span></span><br><span class="line">        <span class="keyword">if</span> (!shouldHandleStateChanges) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 由于 componentWillMount 会在ssr中触发，而 componentDidMount、componentWillUnmount不会。</span></span><br><span class="line">        <span class="comment">// 如果将subscription放在 componentWillMount中，那么 unsubscription 将不会被触发，将会导致内存泄漏。</span></span><br><span class="line">        <span class="keyword">this</span>.subscription.trySubscribe()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为了防止子组件在 componentWillMount 中调用dipatch 所以这里需要在重新计算一次</span></span><br><span class="line">        <span class="comment">// 因为子组件的 componentWillMount 先于组件的 componentDidMount 发生，此时还没有执行 trySubscribe</span></span><br><span class="line">        <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.selector.shouldComponentUpdate) <span class="keyword">this</span>.forceUpdate()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.run(nextProps)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      shouldComponentUpdate() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.selector.shouldComponentUpdate</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      componentWillUnmount() &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.subscription) <span class="keyword">this</span>.subscription.tryUnsubscribe()</span><br><span class="line">        <span class="keyword">this</span>.subscription = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.notifyNestedSubs = noop</span><br><span class="line">        <span class="keyword">this</span>.store = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.selector.run = noop</span><br><span class="line">        <span class="keyword">this</span>.selector.shouldComponentUpdate = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      initSelector() &#123;</span><br><span class="line">        <span class="keyword">const</span> sourceSelector = selectorFactory(<span class="keyword">this</span>.store.dispatch, selectorFactoryOptions)</span><br><span class="line">        <span class="keyword">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="keyword">this</span>.store)</span><br><span class="line">        <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      initSubscription() &#123;</span><br><span class="line">        <span class="keyword">if</span> (!shouldHandleStateChanges) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> parentSub = (<span class="keyword">this</span>.propsMode ? <span class="keyword">this</span>.props : <span class="keyword">this</span>.context)[subscriptionKey]</span><br><span class="line">        <span class="keyword">this</span>.subscription = <span class="keyword">new</span> Subscription(<span class="keyword">this</span>.store, parentSub, <span class="keyword">this</span>.onStateChange.bind(<span class="keyword">this</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里是防止组件在通知过程中卸载，此时this.subscription就为null了。这里将notifyNestedSubs拷贝一次。</span></span><br><span class="line">        <span class="comment">// 并且在componentWillUnmount 中 this.notifyNestedSubs = noop，</span></span><br><span class="line">        <span class="keyword">this</span>.notifyNestedSubs = <span class="keyword">this</span>.subscription.notifyNestedSubs.bind(<span class="keyword">this</span>.subscription)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      onStateChange() &#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.selector.shouldComponentUpdate) &#123;</span><br><span class="line">          <span class="comment">// 如果不需要更新则通知子组件</span></span><br><span class="line">          <span class="keyword">this</span>.notifyNestedSubs()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 如果需要更新则在更新之后，再通知子组件</span></span><br><span class="line">          <span class="keyword">this</span>.componentDidUpdate = <span class="keyword">this</span>.notifyNestedSubsOnComponentDidUpdate</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 组件更新</span></span><br><span class="line">          <span class="keyword">this</span>.setState(dummyState)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      notifyNestedSubsOnComponentDidUpdate() &#123;</span><br><span class="line">        <span class="comment">// 避免重复通知</span></span><br><span class="line">        <span class="keyword">this</span>.componentDidUpdate = <span class="literal">undefined</span></span><br><span class="line">        <span class="keyword">this</span>.notifyNestedSubs()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      isSubscribed() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Boolean</span>(<span class="keyword">this</span>.subscription) &amp;&amp; <span class="keyword">this</span>.subscription.isSubscribed()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      render() &#123;</span><br><span class="line">        <span class="keyword">const</span> selector = <span class="keyword">this</span>.selector</span><br><span class="line">        selector.shouldComponentUpdate = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (selector.error) &#123;</span><br><span class="line">          <span class="keyword">throw</span> selector.error</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> createElement(WrappedComponent, <span class="keyword">this</span>.addExtraProps(selector.props))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* eslint-enable react/no-deprecated */</span></span><br><span class="line"></span><br><span class="line">    Connect.WrappedComponent = WrappedComponent</span><br><span class="line">    Connect.displayName = displayName</span><br><span class="line">    Connect.childContextTypes = childContextTypes</span><br><span class="line">    Connect.contextTypes = contextTypes</span><br><span class="line">    Connect.propTypes = contextTypes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hoistStatics(Connect, WrappedComponent)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>over～ 是不是觉得react-redux很简单？<br>接下来我会将react技术栈中常用的库（react, react-router, redux, redux-saga, dva）源码分析一遍，喜欢的话。可以watch me！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/01/react-redux源码分析及实现原型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/01/react-redux源码分析及实现原型/" itemprop="url">react-redux源码分析及实现原型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-01T22:38:43+08:00">
                2018-09-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>redux作为大型应用的状态管理工具，如果想配合react使用，需要借助react-redux。<br>redux主要完成两件事情：</p>
<ul>
<li>负责应用的状态管理，保证单向数据流</li>
<li>当应用状态发生变化，触发监听器。</li>
</ul>
<p>那么，如果想要将react和redux搭配使用，就需要react组件可以根据redux中所存储的状态（store）更新view。<br>并且可以改变store。其实react-redux主要就是完成了这两件事情。<br>第一，通过将store传入root组件的context，使子节点可以获取到 state。<br>第二，通过store.subscribe 订阅store的变化，更新组件。<br>另外还有对于性能的优化，减少不必要的渲染。</p>
<h3 id="熟悉使用方法"><a href="#熟悉使用方法" class="headerlink" title="熟悉使用方法"></a>熟悉使用方法</h3><p>首先我们熟悉一下react-redux的基本使用<br><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider, connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'add'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...state,</span><br><span class="line">      count: state.count + <span class="number">1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer, &#123; <span class="attr">count</span>: <span class="number">1</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (&#123;</span><br><span class="line">    count: state.count,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> (&#123;</span><br><span class="line">  add: <span class="function"><span class="params">()</span> =&gt;</span> dispatch(&#123; <span class="attr">type</span>: <span class="string">'add'</span> &#125;),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mergeProps = <span class="function">(<span class="params">state, props</span>) =&gt;</span>(&#123;</span><br><span class="line">  countStr: <span class="string">`计数: <span class="subst">$&#123;state.count&#125;</span>`</span>,</span><br><span class="line">  ...props,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  pure: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;p&gt;&#123;<span class="keyword">this</span>.props.countStr&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">        &lt;button onClick=&#123;this.props.add&#125;&gt;点击+1&lt;/</span>button&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const AppContainer = connect(</span></span><br><span class="line"><span class="regexp">  mapStateToProps,</span></span><br><span class="line"><span class="regexp">  mapDispatchToProps,</span></span><br><span class="line"><span class="regexp">  mergeProps,</span></span><br><span class="line"><span class="regexp">  options,</span></span><br><span class="line"><span class="regexp">)(App);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">ReactDOM.render(</span></span><br><span class="line"><span class="regexp">  &lt;Provider store=&#123;store&#125;&gt;</span></span><br><span class="line"><span class="regexp">    &lt;AppContainer a=&#123;123&#125; /</span>&gt;</span><br><span class="line">  &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root'));</span></span><br></pre></td></tr></table></figure></p>
<p>从上面的例子中我们可以看出，react-redux使用非常简单，仅仅使用了两个API，<code>Provider</code> 与 <code>connect</code>。</p>
<ul>
<li>Provider： 接收从redux而来的store，以供子组件使用。</li>
<li>connect： 高阶组件，当组件需要获取或者想要改变store的时候使用。可以接受四个参数：<ul>
<li>mapStateToProps：取store数据，传递给组件。</li>
<li>mapDispatchToProps：改变store数据。</li>
<li>mergeProps：可以在其中对 mapStateToProps， mapDispatchToProps的结果进一步处理</li>
<li>options：一些配置项，例如 pure.当设置为true时，会避免不必要的渲染</li>
</ul>
</li>
</ul>
<h3 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h3><h4 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  getChildContext() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; [storeKey]: <span class="keyword">this</span>[storeKey], [subscriptionKey]: <span class="literal">null</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props, context)</span><br><span class="line">    <span class="keyword">this</span>[storeKey] = props.store;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> Children.only(<span class="keyword">this</span>.props.children)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>够简单吧，仅仅是把store放在了context下。subscriptionKey 可以暂时不用管。</p>
<h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h4><p>首先我们先回忆一下connect使用方法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connect(mapStateToProps,mapDispatchToProps,mergeProps,options)(App);</span><br></pre></td></tr></table></figure></p>
<p>connect源码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnect</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  connectHOC = connectAdvanced,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToPropsFactories = defaultMapStateToPropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  mergePropsFactories = defaultMergePropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  selectorFactory = defaultSelectorFactory</span></span></span><br><span class="line"><span class="function"><span class="params">&#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      pure = true,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="regexp">//</span> ...</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125; = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 封装了传入的mapStateToProps等函数，这里可以先理解为 initMapStateToProps = () =&gt; mapStateToProps 这种形式</span></span><br><span class="line">    <span class="keyword">const</span> initMapStateToProps = match(mapStateToProps, mapStateToPropsFactories, <span class="string">'mapStateToProps'</span>)</span><br><span class="line">    <span class="keyword">const</span> initMapDispatchToProps = match(mapDispatchToProps, mapDispatchToPropsFactories, <span class="string">'mapDispatchToProps'</span>)</span><br><span class="line">    <span class="keyword">const</span> initMergeProps = match(mergeProps, mergePropsFactories, <span class="string">'mergeProps'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选择器（selector）的作用就是计算mapStateToProps，mapDispatchToProps, ownProps（来自父组件的props）的结果，</span></span><br><span class="line">    <span class="comment">// 并将结果传给子组件props。这就是为什么你在mapStateToProps等三个函数中写的结果，子组件可以通过this.props拿到。</span></span><br><span class="line">    <span class="comment">// 选择器工厂函数（selectorFactory）作用就是创建selector</span></span><br><span class="line">    <span class="keyword">return</span> connectHOC(selectorFactory, &#123;</span><br><span class="line">      <span class="comment">// 如果没有传，那么将不会监听state变化</span></span><br><span class="line">      shouldHandleStateChanges: <span class="built_in">Boolean</span>(mapStateToProps),</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 传给selectorFactory的参数</span></span><br><span class="line">      initMapStateToProps,</span><br><span class="line">      initMapDispatchToProps,</span><br><span class="line">      initMergeProps,</span><br><span class="line">      pure,</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createConnect()</span><br></pre></td></tr></table></figure></p>
<p>这段我们可以知道，connect是对connectHOC（connectAdvanced）的封装，connectAdvanced使用了 defaultSelectorFactory，来创建selector。<br>react-redux 默认的 selectorFactory 中包含了很多性能优化的部分（我们一会儿会看到）。<br>其实react-redux 也提供了connectAdvanced API，为了便于大家理解我通过改变开头的例子，了解一下selectorFactory 是如何工作的。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// const AppContainer = connect(</span></span><br><span class="line"><span class="comment">//   mapStateToProps,</span></span><br><span class="line"><span class="comment">//   mapDispatchToProps,</span></span><br><span class="line"><span class="comment">//   mergeProps,</span></span><br><span class="line"><span class="comment">//   options,</span></span><br><span class="line"><span class="comment">// )(App);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在之前我们使用了connect，现在我们使用 connectAdvanced 来实现一下。</span></span><br><span class="line"><span class="comment">// 主要是是实现 selectorFactory：</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selectorFactory</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> result = &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> action = mapDispatchToProps(dispatch);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">nextState, nextOwnProps</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> state = mapStateToProps(nextState);</span><br><span class="line">    <span class="keyword">const</span> nextResult = mergeProps(state, action, nextOwnProps);</span><br><span class="line">    <span class="keyword">if</span> (!shallowEqual(result, nextResult)) result = nextResult</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> AppContainer = connectAdvanced(selectorFactory)(App);</span><br></pre></td></tr></table></figure></p>
<p>这是一个简单的 selectorFactory，主要体现了其是如何工作的，让大家有一个大概的了解。<br>下面来看一下react-redux是如何实现 selectorFactory 的</p>
<h4 id="selectorFactory"><a href="#selectorFactory" class="headerlink" title="selectorFactory"></a>selectorFactory</h4><p><code>在解读代码之前，我想先说一下options.pure的作用。不知道大家还记得吗，在开头的例子有一个配置项pure。作用是减少运算优化性能。当设置为false时，react-redux将不会优化，store.subscirbe事件触发，组件就会渲染，即使是没有用到的state更新，也会这样，举个例子</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 大家都知道reducer的写法</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  ...state,</span><br><span class="line">  count: state.count + <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须返回一个新对象，那么如果我只是修改原来 state 比如</span></span><br><span class="line">state.count += <span class="number">1</span>;</span><br><span class="line"><span class="keyword">return</span> state;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你会发现组件将不会渲染，其实store里的值是发生变化的。</span></span><br><span class="line"><span class="comment">// 这时如果你非想这么写， 然后又想重新渲染怎么办？</span></span><br><span class="line"><span class="comment">// 就是将pure设置为false，这样组件就会完全实时更新。</span></span><br></pre></td></tr></table></figure></p>
<p>举了个不恰当的例子，大家千万不要这么干。。。</p>
<p>源码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">finalPropsSelectorFactory</span>(<span class="params">dispatch, &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  initMapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  initMapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  initMergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  ...options</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mapStateToProps = initMapStateToProps(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mapDispatchToProps = initMapDispatchToProps(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mergeProps = initMergeProps(dispatch, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    verifySubselectors(mapStateToProps, mapDispatchToProps, mergeProps, options.displayName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> selectorFactory = options.pure</span><br><span class="line">    ? pureFinalPropsSelectorFactory</span><br><span class="line">    : impureFinalPropsSelectorFactory</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> selectorFactory(</span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps,</span><br><span class="line">    mergeProps,</span><br><span class="line">    dispatch,</span><br><span class="line">    options</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里很好理解，是对 selectorFactory 的封装，根据 options.pure 的值，选取不同的 SelectorFactory;</p>
<ul>
<li>options.pure 为 false 时，使用 impureFinalPropsSelectorFactory</li>
<li>options.pure 为 true 时，使用 pureFinalPropsSelectorFactory</li>
</ul>
<p>先来看看简单的 <code>impureFinalPropsSelectorFactory</code>，其实和之前实现的 selectorFactory，差不多，无脑计算返回新值。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">impureFinalPropsSelectorFactory</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  dispatch</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">impureFinalPropsSelector</span>(<span class="params">state, ownProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mergeProps(</span><br><span class="line">      mapStateToProps(state, ownProps),</span><br><span class="line">      mapDispatchToProps(dispatch, ownProps),</span><br><span class="line">      ownProps</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>怎么样，和之前自己实现的差不多吧，自己实现的还有一个浅对比呢～ 笑哭</p>
<p><code>pureFinalPropsSelectorFactory</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pureFinalPropsSelectorFactory</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  dispatch,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#123; areStatesEqual, areOwnPropsEqual, areStatePropsEqual &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> hasRunAtLeastOnce = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> state</span><br><span class="line">  <span class="keyword">let</span> ownProps</span><br><span class="line">  <span class="keyword">let</span> stateProps</span><br><span class="line">  <span class="keyword">let</span> dispatchProps</span><br><span class="line">  <span class="keyword">let</span> mergedProps</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleFirstCall</span>(<span class="params">firstState, firstOwnProps</span>) </span>&#123;</span><br><span class="line">    state = firstState</span><br><span class="line">    ownProps = firstOwnProps</span><br><span class="line">    stateProps = mapStateToProps(state, ownProps)</span><br><span class="line">    dispatchProps = mapDispatchToProps(dispatch, ownProps)</span><br><span class="line">    mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line">    hasRunAtLeastOnce = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewPropsAndNewState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    stateProps = mapStateToProps(state, ownProps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mapDispatchToProps.dependsOnOwnProps)</span><br><span class="line">      dispatchProps = mapDispatchToProps(dispatch, ownProps)</span><br><span class="line"></span><br><span class="line">    mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewProps</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleSubsequentCalls</span>(<span class="params">nextState, nextOwnProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> propsChanged = !areOwnPropsEqual(nextOwnProps, ownProps)</span><br><span class="line">    <span class="keyword">const</span> stateChanged = !areStatesEqual(nextState, state)</span><br><span class="line">    state = nextState</span><br><span class="line">    ownProps = nextOwnProps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propsChanged &amp;&amp; stateChanged) <span class="keyword">return</span> handleNewPropsAndNewState()</span><br><span class="line">    <span class="keyword">if</span> (propsChanged) <span class="keyword">return</span> handleNewProps()</span><br><span class="line">    <span class="keyword">if</span> (stateChanged) <span class="keyword">return</span> handleNewState()</span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">pureFinalPropsSelector</span>(<span class="params">nextState, nextOwnProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hasRunAtLeastOnce</span><br><span class="line">      ? handleSubsequentCalls(nextState, nextOwnProps)</span><br><span class="line">      : handleFirstCall(nextState, nextOwnProps)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一句话： 在需要的时候才执行mapStateToProps，mapDispatchToProps，mergeProps<br>为了减少篇幅，挑部分讲解。其实这篇已经很长了有没有，不知道看到这里的你，犯困了没有？<br>还是已经睡着了？ 上个图醒醒脑<br><img src="https://static.dongtu.com/netpic/20161213133159LNLFQ4LP5JEVP0CB_m.webp" alt="Anne Hathaway"></p>
<p>言归正传，这里也分两种情况：</p>
<ul>
<li>当第一次运行时，执行handleFirstCall，将三个map函数运行一遍，并将结果缓存下来</li>
<li>之后运行 handleSubsequentCalls，在其中将新的值和缓存的值做比较，如果变化，将重新求值并返回，如果没变化，返回缓存的旧值。</li>
</ul>
<p>其中 mapFunction.dependsOnOwnProps 代表你传入的mapStateToProps是否使用了ownProps。<br>如果没有使用，那么props的变化将不会影响结果，换句话说对应的mapFunction将不会执行。<br>判断方法也很简单，就是获取function形参长度，如何获得呢？ <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/length" target="_blank" rel="noopener">mdn function.length</a></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这边文章主要讲了react-redux使用方法以及分析了源码中 Provider、connect、selectorFactory。中间也穿插了一些demo方便大家理解。<br>到目前为止大家应该已经熟悉了整个框架的工作流程。由于感觉篇幅过长，所以决定分为两期来讲解。下面一期中主要是剩下的 connectHOC（connectAdvanced），这个才是react-redux的核心。<br>希望看完的朋友没有浪费你们时间，有所帮助，有什么意见尽管提，就当你们自己是产品（🐶）好le.<br>写完又读了一遍，感觉篇幅其实不长，想想应该是自己写的累了。。。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/23/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/23/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-23T22:46:53+08:00">
                2018-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4"
               alt="Jack Zhang" />
          <p class="site-author-name" itemprop="name">Jack Zhang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Zhang</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
