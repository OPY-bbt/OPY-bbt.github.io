<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="大前端">
<meta name="keywords" content="React,Flutter">
<meta property="og:type" content="website">
<meta property="og:title" content="前路漫漫 唯风作伴">
<meta property="og:url" content="https://github.com/OPY-bbt/index.html">
<meta property="og:site_name" content="前路漫漫 唯风作伴">
<meta property="og:description" content="大前端">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="前路漫漫 唯风作伴">
<meta name="twitter:description" content="大前端">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/OPY-bbt/"/>





  <title>前路漫漫 唯风作伴</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">前路漫漫 唯风作伴</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">脚踏大地 仰望星空</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2020/08/01/数据结构与算法-基础题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/01/数据结构与算法-基础题/" itemprop="url">数据结构与算法-基础题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-01T09:26:11+08:00">
                2020-08-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/08/01/数据结构与算法-基础题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/08/01/数据结构与算法-基础题/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="动态数组"><a href="#动态数组" class="headerlink" title="动态数组"></a>动态数组</h3><h3 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h3><h3 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h3><h3 id="约瑟夫问题"><a href="#约瑟夫问题" class="headerlink" title="约瑟夫问题"></a>约瑟夫问题</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 循环链表</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Node</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.val = val;</span><br><span class="line">    <span class="keyword">this</span>.next = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create_linkList</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> head = <span class="keyword">new</span> Node(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> pre = head;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> node = <span class="keyword">new</span> Node(i);</span><br><span class="line">        pre.next = node;</span><br><span class="line">        pre = node;</span><br><span class="line">    &#125;</span><br><span class="line">    pre.next = head;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> all = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> num = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> list = create_linkList(all);</span><br><span class="line">    <span class="keyword">let</span> pre = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> cur = list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(cur.next !== cur) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">            pre = cur;</span><br><span class="line">            cur = cur.next;</span><br><span class="line">        &#125;</span><br><span class="line">        pre.next = cur.next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(cur.val);</span><br><span class="line">&#125;</span><br><span class="line">main();</span><br></pre></td></tr></table></figure>
<h3 id="链表反转"><a href="#链表反转" class="headerlink" title="链表反转"></a>链表反转</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reverseList</span>(<span class="params">head</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// head 为哨兵节点，不需要反转</span></span><br><span class="line">    <span class="keyword">let</span> currentNode = head.next;</span><br><span class="line">    <span class="keyword">let</span> previousNode = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(currentNode) &#123;</span><br><span class="line">        <span class="keyword">let</span> nextNode = currentNode.next;</span><br><span class="line"></span><br><span class="line">        currentNode.next = previousNode;</span><br><span class="line"></span><br><span class="line">        previousNode = currentNode;</span><br><span class="line"></span><br><span class="line">        currentNode = nextNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    head.next = previousNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="检测链表中的环"><a href="#检测链表中的环" class="headerlink" title="检测链表中的环"></a>检测链表中的环</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkCircle</span>(<span class="params">head</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fast = head.next;</span><br><span class="line">    <span class="keyword">let</span> slow = head;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(fast &amp;&amp; fast.next) &#123;</span><br><span class="line">        fast = fast.next.next;</span><br><span class="line">        slow = slow.next;</span><br><span class="line">        <span class="keyword">if</span>(slow === fast) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="链表中间节点"><a href="#链表中间节点" class="headerlink" title="链表中间节点"></a>链表中间节点</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findMiddleNode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fast = <span class="keyword">this</span>.head;</span><br><span class="line">    <span class="keyword">let</span> slow = <span class="keyword">this</span>.head;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(fast.next &amp;&amp; fast.next.next) &#123;</span><br><span class="line">        fast = fast.next.next;</span><br><span class="line">        slow = slow.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> slow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="斐波那契数列"><a href="#斐波那契数列" class="headerlink" title="斐波那契数列"></a>斐波那契数列</h3><h3 id="求阶乘"><a href="#求阶乘" class="headerlink" title="求阶乘"></a>求阶乘</h3><h3 id="二叉树的遍历"><a href="#二叉树的遍历" class="headerlink" title="二叉树的遍历"></a>二叉树的遍历</h3><h3 id="二叉树的高度"><a href="#二叉树的高度" class="headerlink" title="二叉树的高度"></a>二叉树的高度</h3><h3 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h3><h3 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h3><h3 id="八皇后"><a href="#八皇后" class="headerlink" title="八皇后"></a>八皇后</h3><h3 id="背包问题"><a href="#背包问题" class="headerlink" title="背包问题"></a>背包问题</h3><h3 id="DFS-的递归代码"><a href="#DFS-的递归代码" class="headerlink" title="DFS 的递归代码"></a>DFS 的递归代码</h3><h3 id="二分查找"><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h3><h3 id="二分查找变体"><a href="#二分查找变体" class="headerlink" title="二分查找变体"></a>二分查找变体</h3><h3 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h3><h3 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h3><h3 id="堆的三种应用（优先级队列、Top-k、中位数）"><a href="#堆的三种应用（优先级队列、Top-k、中位数）" class="headerlink" title="堆的三种应用（优先级队列、Top k、中位数）"></a>堆的三种应用（优先级队列、Top k、中位数）</h3><h3 id="字符串匹配-BF-算法"><a href="#字符串匹配-BF-算法" class="headerlink" title="字符串匹配 BF 算法"></a>字符串匹配 BF 算法</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2020/07/15/webpack代理实现原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/15/webpack代理实现原理/" itemprop="url">webpack代理实现原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-15T22:53:46+08:00">
                2020-07-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/15/webpack代理实现原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/15/webpack代理实现原理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2020/07/13/回溯算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/13/回溯算法/" itemprop="url">算法思想-回溯</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-13T21:44:13+08:00">
                2020-07-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/13/回溯算法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/13/回溯算法/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>笼统地讲，回溯算法很多时候都应用在“搜索”这类问题上。不过这里说的搜索，并不是狭义的指我们前面讲过的图的搜索算法，而是在一组可能的解中，搜索满足期望的解。回溯的处理思想，有点类似枚举搜索。我们枚举所有的解，找到满足期望的解。</code></p>
<h3 id="八皇后问题"><a href="#八皇后问题" class="headerlink" title="八皇后问题"></a>八皇后问题</h3><p>在8*8的棋盘上放置8个棋子，并且保证行列，左右对角线上都没有棋子。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = [];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cal8queens</span>(<span class="params">row</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (row === <span class="number">8</span>) &#123;</span><br><span class="line">        printQueens(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历列，如果符合要求则进入下一行，DFS</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> column = <span class="number">0</span>; column &lt; <span class="number">8</span>; column++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isOk(row, column)) &#123;</span><br><span class="line">            result[row] = column;</span><br><span class="line">            cal8queens(row + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isOk</span>(<span class="params">row, column</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> leftup = column - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> rightup = column + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = row - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (result[i] === column) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 同一列有值，失败</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (leftup &gt;= <span class="number">0</span>) &#123; <span class="comment">// 左对角线有值，失败</span></span><br><span class="line">            <span class="keyword">if</span> (result[i] == leftup) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (rightup &lt; <span class="number">8</span>) &#123; <span class="comment">//  右对角线有值，失败</span></span><br><span class="line">            <span class="keyword">if</span> (result[i] == rightup) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        leftup--;</span><br><span class="line">        rightup++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printQueens</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> row = <span class="number">0</span>; row &lt; <span class="number">8</span>; row++) &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> column = <span class="number">0</span>; column &lt; <span class="number">8</span>; column++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (result[row] === column) s += <span class="string">"Q "</span>;</span><br><span class="line">            <span class="keyword">else</span> s += <span class="string">"* "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(s + <span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"-----------\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">cal8queens(<span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="0-1背包"><a href="#0-1背包" class="headerlink" title="0-1背包"></a>0-1背包</h3><p>我们有一个背包，背包总的承载重量是 Wkg。现在我们有 n 个物品，每个物品的重量不等，并且不可分割。我们现在期望选择几件物品，装载到背包中。在不超过背包所能装载重量的前提下，如何让背包中物品的总重量最大？<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> maxW = <span class="number">0</span>; <span class="comment">// 存储背包中物品总质量的最大值</span></span><br><span class="line"><span class="comment">// i表示考察到哪个物品了；</span></span><br><span class="line"><span class="comment">// cw 表示当前已经装进去的物品的重量和；</span></span><br><span class="line"><span class="comment">// items 物品重量</span></span><br><span class="line"><span class="comment">// n 物品数量；</span></span><br><span class="line"><span class="comment">// w 背包重量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">i, cw, items, n, w</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cw == w || i == n) &#123; <span class="comment">// 装满了或者考察完所有物品</span></span><br><span class="line">        <span class="keyword">if</span> (cw &gt; maxW) maxW = cw;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于第i个物品，会有装或者不装两种情况</span></span><br><span class="line">    <span class="comment">// 不装第i个物品</span></span><br><span class="line">    f(i+<span class="number">1</span>, cw, items, n, w);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 装第i个物品</span></span><br><span class="line">    <span class="keyword">if</span> (cw + items[i] &lt;= w) &#123;</span><br><span class="line">        f(i + <span class="number">1</span>, cw + items[i], items, n, w);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p>假设正则表达式中只包含“<em>”和“?”这两种通配符，并且对这两个通配符的语义稍微做些改变，其中，“</em>”匹配任意多个（大于等于 0 个）任意字符，“?”匹配零个或者一个任意字符。基于以上背景假设，我们看下，如何用回溯算法，判断一个给定的文本，能否跟给定的正则表达式匹配？<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ti 第i个text字符</span></span><br><span class="line"><span class="comment">// pj 第i个正则字符</span></span><br><span class="line"><span class="comment">// text 文本</span></span><br><span class="line"><span class="comment">// tlen 文本长度</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> matched = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> pattern = <span class="string">""</span>; <span class="comment">// 正则</span></span><br><span class="line"><span class="keyword">const</span> plen = pattern.length;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">ti, pj, text, tlen</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(matched) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pj == plen) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ti === tlen) matched = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pattern[pj] === <span class="string">"*"</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> k = <span class="number">0</span>; k &lt;= tlen - ti; k ++) &#123;</span><br><span class="line">            match(ti + k, pj + <span class="number">1</span>, text, tlen);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern[pj] === <span class="string">"?"</span>) &#123;</span><br><span class="line">        <span class="comment">// 匹配0个字符</span></span><br><span class="line">        match(ti, pj+<span class="number">1</span>, text, tlen);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 匹配1个字符</span></span><br><span class="line">        match(ti + <span class="number">1</span>, pj + <span class="number">1</span>, text, tlen);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ti &lt; tlen &amp;&amp; pattern[pj] == text[ti]) &#123;</span><br><span class="line">        match(ti + <span class="number">1</span>, pj + <span class="number">1</span>, text, tlen);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>回溯算法的思想非常简单，大部分情况下，都是用来解决广义的搜索问题，也就是，从一组可能的解中，选择出一个满足要求的解。回溯算法非常适合用递归来实现，</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2020/06/13/从测试看react源码-scheduler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/13/从测试看react源码-scheduler/" itemprop="url">从测试看react源码_scheduler</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-13T16:25:11+08:00">
                2020-06-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/13/从测试看react源码-scheduler/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/06/13/从测试看react源码-scheduler/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>这是从测试看react源码的第一篇，先从一个独立的 Scheduler 模块入手。正如官方所说，Scheduler模块是一个用于协作调度任务的包，防止浏览器主线程长时间忙于运行一些事情，关键任务的执行被推迟。用于 react 内部，现在将它独立出来，将来会成为公开API</code></p>
<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><ul>
<li>下载源码到本地，我使用的分支是 master(4c7036e80)</li>
<li>由于 react 测试代码太多，如果想要仅测试 scheduler 部分代码，需要修改一下jest配置</li>
<li><p>打开 package.json，可以看到 test 命令的配置文件是 config.source.js</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;test&quot;: &quot;cross-env NODE_ENV=development jest --config ./scripts/jest/config.source.js&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在其中我们可以看到又引入了 config.base.js 文件，接下来就是修改 config.base.js</p>
  <figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- testRegex: '/__tests__/[^/]*(\\.js|\\.coffee|[^d]\\.ts)$',</span></span><br><span class="line"><span class="addition">+ testRegex: '/__tests__/Scheduler-test.js',</span></span><br><span class="line">moduleFileExtensions: ['js', 'json', 'node', 'coffee', 'ts'],</span><br><span class="line">rootDir: process.cwd(),</span><br><span class="line"><span class="deletion">- roots: ['&lt;rootDir&gt;/packages', '&lt;rootDir&gt;/scripts'],</span></span><br><span class="line"><span class="addition">+ roots: ['&lt;rootDir&gt;/packages/scheduler'],</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在项目根目录下运行 yarn run test，不出意外会看到测试成功运行</p>
</li>
</ul>
<h3 id="jest-相关介绍"><a href="#jest-相关介绍" class="headerlink" title="jest 相关介绍"></a>jest 相关介绍</h3><p>在开始之前，先了解一下jest的运行环境，省的一会找不到代码对应位置</p>
<ul>
<li>jest.mock()用于mock某个模块，比如<code>jest.mock(&#39;scheduler&#39;, () =&gt; require(&#39;scheduler/unstable_mock&#39;));</code>， 那么之后 <code>require(&#39;scheduler&#39;)</code> 其实就是引入的 <code>scheduler/unstable_mock.js</code></li>
<li>如果你看到以 hostConfig 结尾的文件名中内容是 <code>throw new Error(&#39;This module must be shimmed by a specific build.&#39;);</code>，那么就去 <code>scripts/jest/setupHostConfig.js</code>中去查看到底使用了哪个文件。</li>
<li>expect(xx).Function() 这里的 Function 被称为 matcher。 在 jest 中有些默认的 matcher，比如说 toEqual,也可以自定义。scripts/jest/matchers 就是一些 react 自定义的。</li>
</ul>
<h3 id="miniHeap"><a href="#miniHeap" class="headerlink" title="miniHeap"></a>miniHeap</h3><p>scheduler 用于调度任务，防止浏览器主线程长时间忙于运行一些事情，关键任务的执行却被推迟。那么任务就要有一个优先级，每次优先执行优先级最高的任务。在 schuduler 中有两个任务队列，taskQueue 和 timerQueue 队列，是最小堆实现的优先队列。数组第一项永远为优先级最高的子项。</p>
<h3 id="Scheduler-test-js"><a href="#Scheduler-test-js" class="headerlink" title="Scheduler-test.js"></a>Scheduler-test.js</h3><h5 id="1-flushes-work-incrementally"><a href="#1-flushes-work-incrementally" class="headerlink" title="1. flushes work incrementally"></a>1. flushes work incrementally</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">it(&apos;flushes work incrementally&apos;, () =&gt; &#123;</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; Scheduler.unstable_yieldValue(&apos;A&apos;));</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; Scheduler.unstable_yieldValue(&apos;B&apos;));</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; Scheduler.unstable_yieldValue(&apos;C&apos;));</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; Scheduler.unstable_yieldValue(&apos;D&apos;));</span><br><span class="line"></span><br><span class="line">  expect(Scheduler).toFlushAndYieldThrough([&apos;A&apos;, &apos;B&apos;]);</span><br><span class="line">  expect(Scheduler).toFlushAndYieldThrough([&apos;C&apos;]);</span><br><span class="line">  expect(Scheduler).toFlushAndYield([&apos;D&apos;]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>Scheduler.unstable_yieldValue</code> 函数比较简单，就是将参数push到一个数组中，用于结果的比较。<br><code>scheduleCallback</code> 中会构造 Task, 如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 构造Task</span><br><span class="line">var newTask = &#123;</span><br><span class="line">  id: taskIdCounter++,</span><br><span class="line">  callback,</span><br><span class="line">  priorityLevel,</span><br><span class="line">  startTime,</span><br><span class="line">  expirationTime,</span><br><span class="line">  sortIndex: -1,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>并将其加入 taskQueue 或者 timerQueue。如果当前没有任务在执行则调用 <code>requestHostCallback(flushWork);</code> 用于执行任务。<br>在测试环境中 requestHostCallback 的实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function requestHostCallback(callback: boolean =&gt; void) &#123;</span><br><span class="line">  scheduledCallback = callback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>仅仅是保存了 flushWork 函数, 并没有执行。<br>传入的 <code>flushWork</code> 函数返回 boolean 变量，当 true 时为有 task 可以执行，但是当前时间切片已结束，将空出主线程给浏览器。其中执行 <code>workLoop</code>，<code>workLoop</code> 是任务执行的真正地方。其首先会从当前 timerQueue 中取出定时已经到期的timer，将其加入到 taskQueue 中。接来下就是取出 taskQueue 中的任务并执行。<code>workLoop</code> 代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// 取出已经到时的 timer，放入 taskQueue 中。</span><br><span class="line">advanceTimers(currentTime);</span><br><span class="line"></span><br><span class="line">currentTask = peek(taskQueue);</span><br><span class="line">while (</span><br><span class="line">  currentTask !== null &amp;&amp;</span><br><span class="line">  !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)</span><br><span class="line">) &#123;</span><br><span class="line">  if (</span><br><span class="line">    currentTask.expirationTime &gt; currentTime &amp;&amp;</span><br><span class="line">    (!hasTimeRemaining || shouldYieldToHost())</span><br><span class="line">  ) &#123;</span><br><span class="line">    // This currentTask hasn&apos;t expired, and we&apos;ve reached the deadline.</span><br><span class="line">    break;</span><br><span class="line">  &#125;</span><br><span class="line">  const callback = currentTask.callback;</span><br><span class="line">  if (callback !== null) &#123;</span><br><span class="line">    currentTask.callback = null;</span><br><span class="line">    currentPriorityLevel = currentTask.priorityLevel;</span><br><span class="line">    const didUserCallbackTimeout = currentTask.expirationTime &lt;= currentTime;</span><br><span class="line">    markTaskRun(currentTask, currentTime);</span><br><span class="line">    const continuationCallback = callback(didUserCallbackTimeout);</span><br><span class="line">    currentTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">    if (typeof continuationCallback === &apos;function&apos;) &#123;</span><br><span class="line">      // 当前任务执行过程中被中断，则将之后需要继续执行的callback保存下来</span><br><span class="line">      currentTask.callback = continuationCallback;</span><br><span class="line">      markTaskYield(currentTask, currentTime);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (enableProfiling) &#123;</span><br><span class="line">        markTaskCompleted(currentTask, currentTime);</span><br><span class="line">        currentTask.isQueued = false;</span><br><span class="line">      &#125;</span><br><span class="line">      if (currentTask === peek(taskQueue)) &#123;</span><br><span class="line">        pop(taskQueue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    advanceTimers(currentTime);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 已经取消的任务，调用unstable_cancelCallback方法取消任务</span><br><span class="line">    pop(taskQueue);</span><br><span class="line">  &#125;</span><br><span class="line">  currentTask = peek(taskQueue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>循环取出 taskQueue 中的任务，直到 taskQueue 为空，或者当前时间切片时间已到并且任务也还没有过期，中断循环。把任务放到下一个时间切片执行。注意一下 <code>shouldYieldToHost()</code>，这个也是判断是否继续执行的条件，之后会用到。</p>
<p>1-4 行代码结果就是将四个 task 推入taskQueue，等待执行。然后去看一下 matcher <code>toFlushAndYieldThrough</code>, 位置在 <code>scripts/jest/matchers/schedulerTestMatchers.js</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function toFlushAndYieldThrough(Scheduler, expectedYields) &#123;</span><br><span class="line">  assertYieldsWereCleared(Scheduler);</span><br><span class="line">  Scheduler.unstable_flushNumberOfYields(expectedYields.length);</span><br><span class="line">  const actualYields = Scheduler.unstable_clearYields();</span><br><span class="line">  return captureAssertion(() =&gt; &#123;</span><br><span class="line">    expect(actualYields).toEqual(expectedYields);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行与 expectedYields(就是test里的[‘A’, ‘B’]，[‘C’]，[‘D’] ) 数量相同的任务，看结果是否相等<br><code>unstable_flushNumberOfYields</code> 代码如下，这里的cb就是 flushWork，第一个参数为 true表示当前切片有剩余时间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">export function unstable_flushNumberOfYields(count: number): void &#123;</span><br><span class="line">  if (isFlushing) &#123;</span><br><span class="line">    throw new Error(&apos;Already flushing work.&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">  if (scheduledCallback !== null) &#123;</span><br><span class="line">    const cb = scheduledCallback;</span><br><span class="line">    expectedNumberOfYields = count;</span><br><span class="line">    isFlushing = true;</span><br><span class="line">    try &#123;</span><br><span class="line">      let hasMoreWork = true;</span><br><span class="line">      do &#123;</span><br><span class="line">        // 执行任务</span><br><span class="line">        hasMoreWork = cb(true, currentTime);</span><br><span class="line">      &#125; while (hasMoreWork &amp;&amp; !didStop);</span><br><span class="line">      if (!hasMoreWork) &#123;</span><br><span class="line">        scheduledCallback = null;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      expectedNumberOfYields = -1;</span><br><span class="line">      didStop = false;</span><br><span class="line">      isFlushing = false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么何时停止呢？记得之前的 <code>shouldYieldToHost</code> 函数吗，在 schedulerHostConfig.mock.js 在实现了此函数，并且添加了一个 didStop 变量用于测试中控制数量，当达到 expectedNumberOfYields 数量时退出循环。代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">export function shouldYieldToHost(): boolean &#123;</span><br><span class="line">  if (</span><br><span class="line">    (expectedNumberOfYields !== -1 &amp;&amp;</span><br><span class="line">      yieldedValues !== null &amp;&amp;</span><br><span class="line">      yieldedValues.length &gt;= expectedNumberOfYields) ||</span><br><span class="line">    (shouldYieldForPaint &amp;&amp; needsPaint)</span><br><span class="line">  ) &#123;</span><br><span class="line">    // We yielded at least as many values as expected. Stop flushing.</span><br><span class="line">    didStop = true;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line">  return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="2-cancels-work"><a href="#2-cancels-work" class="headerlink" title="2. cancels work"></a>2. cancels work</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">it(&apos;cancels work&apos;, () =&gt; &#123;</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; Scheduler.unstable_yieldValue(&apos;A&apos;));</span><br><span class="line">  const callbackHandleB = scheduleCallback(NormalPriority, () =&gt;</span><br><span class="line">    Scheduler.unstable_yieldValue(&apos;B&apos;),</span><br><span class="line">  );</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; Scheduler.unstable_yieldValue(&apos;C&apos;));</span><br><span class="line"></span><br><span class="line">  // 取消任务即把task.callback设置为null，</span><br><span class="line">  cancelCallback(callbackHandleB);</span><br><span class="line"></span><br><span class="line">  expect(Scheduler).toFlushAndYield([</span><br><span class="line">    &apos;A&apos;,</span><br><span class="line">    // B should have been cancelled</span><br><span class="line">    &apos;C&apos;,</span><br><span class="line">  ]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>将task callback 设置为 null 就是取消任务，这部分在 workLoop里有判断</p>
<h5 id="3-executes-the-highest-priority-callbacks-first"><a href="#3-executes-the-highest-priority-callbacks-first" class="headerlink" title="3. executes the highest priority callbacks first"></a>3. executes the highest priority callbacks first</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">it(&apos;executes the highest priority callbacks first&apos;, () =&gt; &#123;</span><br><span class="line">  // 这加入taskQueue时，用最小堆排序算法排序的</span><br><span class="line"></span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; Scheduler.unstable_yieldValue(&apos;A&apos;));</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; Scheduler.unstable_yieldValue(&apos;B&apos;));</span><br><span class="line"></span><br><span class="line">  // Yield before B is flushed</span><br><span class="line">  expect(Scheduler).toFlushAndYieldThrough([&apos;A&apos;]);</span><br><span class="line"></span><br><span class="line">  scheduleCallback(UserBlockingPriority, () =&gt;</span><br><span class="line">    Scheduler.unstable_yieldValue(&apos;C&apos;),</span><br><span class="line">  );</span><br><span class="line">  scheduleCallback(UserBlockingPriority, () =&gt;</span><br><span class="line">    Scheduler.unstable_yieldValue(&apos;D&apos;),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  // C and D should come first, because they are higher priority</span><br><span class="line">  expect(Scheduler).toFlushAndYield([&apos;C&apos;, &apos;D&apos;, &apos;B&apos;]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在 scheduler 中定义了6中优先级:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export const NoPriority = 0;</span><br><span class="line">export const ImmediatePriority = 1;</span><br><span class="line">export const UserBlockingPriority = 2;</span><br><span class="line">export const NormalPriority = 3;</span><br><span class="line">export const LowPriority = 4;</span><br><span class="line">export const IdlePriority = 5;</span><br></pre></td></tr></table></figure></p>
<p>每种优先级又对应了不同的超时时间:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Times out immediately</span><br><span class="line">var IMMEDIATE_PRIORITY_TIMEOUT = -1;</span><br><span class="line">// Eventually times out</span><br><span class="line">var USER_BLOCKING_PRIORITY_TIMEOUT = 250;</span><br><span class="line">var NORMAL_PRIORITY_TIMEOUT = 5000;</span><br><span class="line">var LOW_PRIORITY_TIMEOUT = 10000;</span><br><span class="line">// Never times out</span><br><span class="line">var IDLE_PRIORITY_TIMEOUT = maxSigned31BitInt;</span><br></pre></td></tr></table></figure></p>
<p>其中 NoPriority 和 NormalPriority 的超时时间一样,这可以在 scheduler.js中看到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function timeoutForPriorityLevel(priorityLevel) &#123;</span><br><span class="line">  switch (priorityLevel) &#123;</span><br><span class="line">    case ImmediatePriority:</span><br><span class="line">      return IMMEDIATE_PRIORITY_TIMEOUT;</span><br><span class="line">    case UserBlockingPriority:</span><br><span class="line">      return USER_BLOCKING_PRIORITY_TIMEOUT;</span><br><span class="line">    case IdlePriority:</span><br><span class="line">      return IDLE_PRIORITY_TIMEOUT;</span><br><span class="line">    case LowPriority:</span><br><span class="line">      return LOW_PRIORITY_TIMEOUT;</span><br><span class="line">    case NormalPriority:</span><br><span class="line">    default:</span><br><span class="line">      return NORMAL_PRIORITY_TIMEOUT;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在新建任务时会根据当前时间和超时时间计算出过期时间，taskQueue 是按照过期时间排序的。优先级高的任务，过期时间就会越小，所以会先被执行。</p>
<h5 id="4-expires-work"><a href="#4-expires-work" class="headerlink" title="4. expires work"></a>4. expires work</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">it(&apos;expires work&apos;, () =&gt; &#123;</span><br><span class="line">    scheduleCallback(NormalPriority, didTimeout =&gt; &#123;</span><br><span class="line">      Scheduler.unstable_advanceTime(100);</span><br><span class="line">      Scheduler.unstable_yieldValue(`A (did timeout: $&#123;didTimeout&#125;)`);</span><br><span class="line">    &#125;);</span><br><span class="line">    scheduleCallback(UserBlockingPriority, didTimeout =&gt; &#123;</span><br><span class="line">      Scheduler.unstable_advanceTime(100);</span><br><span class="line">      Scheduler.unstable_yieldValue(`B (did timeout: $&#123;didTimeout&#125;)`);</span><br><span class="line">    &#125;);</span><br><span class="line">    scheduleCallback(UserBlockingPriority, didTimeout =&gt; &#123;</span><br><span class="line">      Scheduler.unstable_advanceTime(100);</span><br><span class="line">      Scheduler.unstable_yieldValue(`C (did timeout: $&#123;didTimeout&#125;)`);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // Advance time, but not by enough to expire any work</span><br><span class="line">    Scheduler.unstable_advanceTime(249);</span><br><span class="line">    expect(Scheduler).toHaveYielded([]);</span><br><span class="line"></span><br><span class="line">    // Schedule a few more callbacks</span><br><span class="line">    scheduleCallback(NormalPriority, didTimeout =&gt; &#123;</span><br><span class="line">      Scheduler.unstable_advanceTime(100);</span><br><span class="line">      Scheduler.unstable_yieldValue(`D (did timeout: $&#123;didTimeout&#125;)`);</span><br><span class="line">    &#125;);</span><br><span class="line">    scheduleCallback(NormalPriority, didTimeout =&gt; &#123;</span><br><span class="line">      Scheduler.unstable_advanceTime(100);</span><br><span class="line">      Scheduler.unstable_yieldValue(`E (did timeout: $&#123;didTimeout&#125;)`);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // Advance by just a bit more to expire the user blocking callbacks</span><br><span class="line"></span><br><span class="line">    // currentTime被设置成249 + 1 而 UserBlockingPriority 的timeout为250，所以超时执行</span><br><span class="line">    Scheduler.unstable_advanceTime(1);</span><br><span class="line">    expect(Scheduler).toFlushExpired([</span><br><span class="line">      &apos;B (did timeout: true)&apos;,</span><br><span class="line">      &apos;C (did timeout: true)&apos;,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    // Expire A</span><br><span class="line">    // 250 + 100 + 100 + 4600 = 5050 &gt; 5000(NORMAL_PRIORITY_TIMEOUT)</span><br><span class="line">    Scheduler.unstable_advanceTime(4600);</span><br><span class="line">    expect(Scheduler).toFlushExpired([&apos;A (did timeout: true)&apos;]);</span><br><span class="line"></span><br><span class="line">    // Flush the rest without expiring</span><br><span class="line">    expect(Scheduler).toFlushAndYield([</span><br><span class="line">      &apos;D (did timeout: false)&apos;,</span><br><span class="line">      &apos;E (did timeout: true)&apos;,</span><br><span class="line">    ]);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>UserBlockingPriority 类型的任务，新建 task 时设置过期时间为当前时间 + USER_BLOCKING_PRIORITY_TIMEOUT（250）， 而 NormalPriority 则为 当前时间 + NORMAL_PRIORITY_TIMEOUT（5000）。<br>unstable_advanceTime 作用是就是增量当前时间。比如 unstable_advanceTime(100)，意味这当前时间增加了 100ms，如果当前时间大于过期时间，则任务过期。<br>在最后调用 scheduledCallback 时, 代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">export function unstable_flushExpired() &#123;</span><br><span class="line">  if (isFlushing) &#123;</span><br><span class="line">    throw new Error(&apos;Already flushing work.&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">  if (scheduledCallback !== null) &#123;</span><br><span class="line">    isFlushing = true;</span><br><span class="line">    try &#123;</span><br><span class="line">      const hasMoreWork = scheduledCallback(false, currentTime);</span><br><span class="line">      if (!hasMoreWork) &#123;</span><br><span class="line">        scheduledCallback = null;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      isFlushing = false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在其中调用 scheduledCallback(也就是 flushWork) 时将 hasTimeRemaining 参数设置为false，当前时间切片未有剩余，仅任务过期才会执行，未过期则放到下一个时间切片执行。这里的第一个测试  Scheduler.unstable_advanceTime(249)，有些多余，不管设置成多少都不会有变化。<br>这里需要注意的是D， E 任务过期时间为 5249，所以最后 D 任务没有过期 而 E 任务过期了。</p>
<h5 id="5-continues-working-on-same-task-after-yielding"><a href="#5-continues-working-on-same-task-after-yielding" class="headerlink" title="5. continues working on same task after yielding"></a>5. continues working on same task after yielding</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">it(&apos;continues working on same task after yielding&apos;, () =&gt; &#123;</span><br><span class="line">  // workLoop 中如果callback执行之后返回函数，会把返回的函数再次存入task对象的callback中保存下来</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; &#123;</span><br><span class="line">    Scheduler.unstable_advanceTime(100);</span><br><span class="line">    Scheduler.unstable_yieldValue(&apos;A&apos;);</span><br><span class="line">  &#125;);</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; &#123;</span><br><span class="line">    Scheduler.unstable_advanceTime(100);</span><br><span class="line">    Scheduler.unstable_yieldValue(&apos;B&apos;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  let didYield = false;</span><br><span class="line">  const tasks = [</span><br><span class="line">    [&apos;C1&apos;, 100],</span><br><span class="line">    [&apos;C2&apos;, 100],</span><br><span class="line">    [&apos;C3&apos;, 100],</span><br><span class="line">  ];</span><br><span class="line">  const C = () =&gt; &#123;</span><br><span class="line">    while (tasks.length &gt; 0) &#123;</span><br><span class="line">      const [label, ms] = tasks.shift();</span><br><span class="line">      Scheduler.unstable_advanceTime(ms);</span><br><span class="line">      Scheduler.unstable_yieldValue(label);</span><br><span class="line">      if (shouldYield()) &#123;</span><br><span class="line">        didYield = true;</span><br><span class="line">        return C;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  scheduleCallback(NormalPriority, C);</span><br><span class="line"></span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; &#123;</span><br><span class="line">    Scheduler.unstable_advanceTime(100);</span><br><span class="line">    Scheduler.unstable_yieldValue(&apos;D&apos;);</span><br><span class="line">  &#125;);</span><br><span class="line">  scheduleCallback(NormalPriority, () =&gt; &#123;</span><br><span class="line">    Scheduler.unstable_advanceTime(100);</span><br><span class="line">    Scheduler.unstable_yieldValue(&apos;E&apos;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // Flush, then yield while in the middle of C.</span><br><span class="line">  expect(didYield).toBe(false);</span><br><span class="line">  expect(Scheduler).toFlushAndYieldThrough([&apos;A&apos;, &apos;B&apos;, &apos;C1&apos;]);</span><br><span class="line">  expect(didYield).toBe(true);</span><br><span class="line"></span><br><span class="line">  // When we resume, we should continue working on C.</span><br><span class="line">  expect(Scheduler).toFlushAndYield([&apos;C2&apos;, &apos;C3&apos;, &apos;D&apos;, &apos;E&apos;]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里主要看下任务C，其 callback 其最后又返回了自身，相当于任务的子任务，被中断之后，下一个时间切片继续执行子任务。子任务继承了父任务的所有参数，当执行完当前子任务之后，仅仅需要设置父任务 callback 函数为下一个子任务 callback，在 workLoop 中的相关代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const continuationCallback = callback(didUserCallbackTimeout);</span><br><span class="line">currentTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">if (typeof continuationCallback === &apos;function&apos;) &#123;</span><br><span class="line">    // 当前任务执行过程中被中断，则将之后需要继续执行的callback保存下来</span><br><span class="line">    currentTask.callback = continuationCallback;</span><br><span class="line">    markTaskYield(currentTask, currentTime);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    if (enableProfiling) &#123;</span><br><span class="line">        markTaskCompleted(currentTask, currentTime);</span><br><span class="line">        currentTask.isQueued = false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (currentTask === peek(taskQueue)) &#123;</span><br><span class="line">        pop(taskQueue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>目前讲解了5个测试，而关于 scheduler 中的测试还有很多，更多的细节还需要自己去分析，希望本文可以起到抛砖引玉的作用，给你起了个阅读源码的头，勿急勿躁。下次会分享 schedulerBrowser-test，模拟浏览器环境对 scheduler 进行测试。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2018/10/23/react-filber/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/23/react-filber/" itemprop="url">react fiber(译)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-23T22:37:05+08:00">
                2018-10-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/23/react-filber/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/10/23/react-filber/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是一篇讲react Fiber算法的文章，深入浅出，并且作者自己实现了Fiber的核心代码，可以很好的帮助我们理解fiber<br><a href="https://engineering.hexacta.com/didact-fiber-incremental-reconciliation-b2fe028dcaec" target="_blank" rel="noopener">原文链接</a></p>
<p>另外，建议读这篇文章之前先看一下他的另外几篇关于react的文章，本篇是建立在其之上的<br><a href="https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5" target="_blank" rel="noopener">DIY React</a></p>
<h2 id="Didact-Fiber-Incremental-reconciliation"><a href="#Didact-Fiber-Incremental-reconciliation" class="headerlink" title="Didact Fiber: Incremental reconciliation"></a>Didact Fiber: Incremental reconciliation</h2><p><a href="https://github.com/pomber/didact">github repository</a><br><a href="https://codepen.io/pomber/pen/veVOdd" target="_blank" rel="noopener">updated demo</a></p>
<h3 id="Why-Fiber"><a href="#Why-Fiber" class="headerlink" title="Why Fiber"></a>Why Fiber</h3><blockquote>
<p>本文并不会展示一个完整的React Fiber,如果你想了解更多，<a href="https://github.com/koba04/react-fiber-resources">更多资料</a></p>
</blockquote>
<p>当浏览器的主线程长时间忙于运行一些事情时，关键任务的执行可以能被推迟。</p>
<p>为了展示这个问题，我做了一个<a href="https://pomber.github.io/incremental-rendering-demo/react-sync.html" target="_blank" rel="noopener">demo</a>，为了使星球一直转动，主线程需要每16ms被调用一次，因为animation是跑在主线程上的。如果主线程被其他事情占用，假如占用了200ms，你会发现animation会发生卡顿，星球停止运行，直到主线程空闲出来运行animation。</p>
<p>到底是什么导致主线程如此繁忙导致不能空闲出几微秒去保持动画流畅和响应及时呢？</p>
<p>还记得以前实现的<a href="https://engineering.hexacta.com/didact-instances-reconciliation-and-virtual-dom-9316d650f1d0" target="_blank" rel="noopener">reconciliation code</a>吗？一旦开始，就无法停止。如果此时主线程需要做些别的事情，那就只能等待。并且因为使用了许多递归，导致很难暂停。这就是为什么我们重写代码，用循环代替递归。</p>
<h3 id="Scheduling-micro-tasks"><a href="#Scheduling-micro-tasks" class="headerlink" title="Scheduling micro-tasks"></a>Scheduling micro-tasks</h3><p>我们需要把任务分成一个个子任务，在很短的时间里运行结束掉。可以让主线程先去做优先级更高的任务，然后再回来做优先级低的任务。</p>
<p>我们将会需要<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener">requestIdleCallback()</a>函数的帮助。它在浏览器空闲时才执行callback函数，回调函数中<code>deadline</code>参数会告诉你还有多少空闲时间来运行代码，如果剩余时间不够，那么你可以选择不执行代码，保持了主线程不会被一直占用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ENOUGH_TIME = <span class="number">1</span>; <span class="comment">// milliseconds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> workQueue = [];</span><br><span class="line"><span class="keyword">let</span> nextUnitOfWork = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">schedule</span>(<span class="params">task</span>) </span>&#123;</span><br><span class="line">  workQueue.push(task);</span><br><span class="line">  requestIdleCallback(performWork);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWork</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!nextUnitOfWork) &#123;</span><br><span class="line">    nextUnitOfWork = workQueue.shift();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; ENOUGH_TIME) &#123;</span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextUnitOfWork || workQueue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    requestIdleCallback(performWork);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>真正起作用的函数是performUnitOfWork。我们将会在其中写reconciliation code。函数运行一次占用很少的时间，并且返回下一次任务的信息。</p>
<p>为了组织这些子任务，我们将会使用fibers</p>
<h3 id="The-fiber-data-structure"><a href="#The-fiber-data-structure" class="headerlink" title="The fiber data structure"></a>The fiber data structure</h3><p>我们将会为每一个需要渲染的组件创建一个fiber。<code>nextUnitOfWork</code>是对将要运行的下一个fiber的引用。<code>performUnitOfWork</code>会对fiber进行diff，然后返回下一个fiber。这个将会在后面详细解释。</p>
<p>fiber是啥样子的呢？<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fiber = &#123;</span><br><span class="line">  tag: HOST_COMPONENT,</span><br><span class="line">  type: <span class="string">"div"</span>,</span><br><span class="line">  parent: parentFiber,</span><br><span class="line">  child: childFiber,</span><br><span class="line">  sibling: <span class="literal">null</span>,</span><br><span class="line">  alternate: currentFiber,</span><br><span class="line">  stateNode: <span class="built_in">document</span>.createElement(<span class="string">"div"</span>),</span><br><span class="line">  props: &#123; <span class="attr">children</span>: [], <span class="attr">className</span>: <span class="string">"foo"</span>&#125;,</span><br><span class="line">  partialState: <span class="literal">null</span>,</span><br><span class="line">  effectTag: PLACEMENT,</span><br><span class="line">  effects: []</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>是一个对象啊，我们将会使用parent，child，sibling属性去构建fiber树来表示组件的结构树。</p>
<p><code>stateNode</code>是对组件实例的引用。他可能是DOM元素或者用户定义的类组件实例</p>
<p>举个例子：<br><img src="../images/fiber_tree.png" alt="fiber_tree"></p>
<p>在上面例子中我们可以看到将支持三种不同的组件：</p>
<ul>
<li>b, p, i 代表着<code>host component</code>。我们将会用tag：HOST_COMPONENT来定义他。type属性将会是字符串。props是dom属性和事件。</li>
<li>Foo class component。它的tag：CLASS_COMPONENT， type指向用户定义的类组件</li>
<li>div代表着 host root。他类似于host component，stateNode也是DOM element.tag: HOST_ROOT.注意stateNode就是传递给render函数的参数。</li>
</ul>
<p>另外一个重要属性就是<code>alternate</code>，我们需要它是因为大多数时间我们将会有两个fiber tree。一个代表着已经渲染的dom， 我们成其为current tree 或者 old tree。另外一个是在更新（当调用setState或者render）时创建的，称其为work-in-progress tree。</p>
<p>work-in-progress tree不会与old tree共享任何fiber。一旦我们完成work-in-progress tree的构建和dom的改变，work-in-progress tree就变成了old tree。</p>
<p>所以我们使用alternate属性去链接old tree。fiber与其alternate有相同的tag，type，statenode。有时我们渲染新的组件，它可能没有alternate属性</p>
<p>然后，还有一个effects 列表和effectTag。当我们发现work-in-progress需要改变的DOM时，就将<code>effectTag</code>设置为<code>PLACEMENT</code>, <code>UPDATE</code>, <code>DELETION</code>。为了更容易知道总共有哪些需要fiber需要改变DOM，我们把所有的fiber放在effects列表里。</p>
<p>可能这里讲了许多概念的东西，不要担心，我们将会用行动来展示fiber。</p>
<h3 id="Didact-call-hierarchy"><a href="#Didact-call-hierarchy" class="headerlink" title="Didact call hierarchy"></a>Didact call hierarchy</h3><p>为了对程序有整体的理解，我们先看一下结构示意图<br><img src="../images/fiber_call_hierarchy.png" alt="fiber_call_hierarchy"></p>
<p>我们将会从<code>render()</code>和<code>setState()</code>开始，在commitAllWork()结束</p>
<h3 id="Old-code"><a href="#Old-code" class="headerlink" title="Old code"></a>Old code</h3><p>我之前告诉你我们将重构大部分代码，但在这之前，我们先回顾一下不需要重构的代码</p>
<blockquote>
<p>这里我就不一一翻译了，这些代码都是在文章开头我提到的</p>
</blockquote>
<ul>
<li><a href="https://engineering.hexacta.com/didact-element-creation-and-jsx-d05171c55c56" target="_blank" rel="noopener">Element creation and JSX</a></li>
<li><a href="https://engineering.hexacta.com/didact-instances-reconciliation-and-virtual-dom-9316d650f1d0" target="_blank" rel="noopener">Instances, reconciliation and virtual DOM</a></li>
<li><a href="https://engineering.hexacta.com/didact-components-and-state-53ab4c900e37" target="_blank" rel="noopener">Components and state</a>,这里的 Class Component需要稍微改动一下<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">this</span>.props = props || &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">this</span>.state || &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(partialState) &#123;</span><br><span class="line">    scheduleUpdate(<span class="keyword">this</span>, partialState);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createInstance</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> fiber.type(fiber.props);</span><br><span class="line">  instance.__fiber = fiber;</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="render-amp-scheduleUpdate"><a href="#render-amp-scheduleUpdate" class="headerlink" title="render() &amp; scheduleUpdate()"></a>render() &amp; scheduleUpdate()</h3><p><img src="../images/fiber_render_scheduleUpdate.png" alt="render &amp; scheduleUpdate"><br>除了<code>Component</code>, <code>createElement</code>, 我们将会有两个公共函数<code>render()</code>, <code>setState()</code>，我们已经看到<code>setState()</code> 仅仅调用了<code>scheduleUpdate()</code>。</p>
<p><code>render()</code> 和 <code>scheduleUpdate()</code>非常类似，他们接收新的更新并且进入队列。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/ Fiber tags</span><br><span class="line"><span class="keyword">const</span> HOST_COMPONENT = <span class="string">"host"</span>;</span><br><span class="line"><span class="keyword">const</span> CLASS_COMPONENT = <span class="string">"class"</span>;</span><br><span class="line"><span class="keyword">const</span> HOST_ROOT = <span class="string">"root"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Global state</span></span><br><span class="line"><span class="keyword">const</span> updateQueue = [];</span><br><span class="line"><span class="keyword">let</span> nextUnitOfWork = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> pendingCommit = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">elements, containerDom</span>) </span>&#123;</span><br><span class="line">  updateQueue.push(&#123;</span><br><span class="line">    <span class="keyword">from</span>: HOST_ROOT,</span><br><span class="line">    dom: containerDom,</span><br><span class="line">    newProps: &#123; <span class="attr">children</span>: elements &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  requestIdleCallback(performWork);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdate</span>(<span class="params">instance, partialState</span>) </span>&#123;</span><br><span class="line">  updateQueue.push(&#123;</span><br><span class="line">    <span class="keyword">from</span>: CLASS_COMPONENT,</span><br><span class="line">    instance: instance,</span><br><span class="line">    partialState: partialState</span><br><span class="line">  &#125;);</span><br><span class="line">  requestIdleCallback(performWork);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们将会使用<code>updateQueue</code>数组来存储等待的更新。每一次调用<code>render</code> 或者 <code>scheduleUpdate</code> 都会将数据存储进<code>updateQueue</code>。数组里每一个数据都不一样，我们将会在<code>resetNextUnitOfWork()</code>函数中使用。</p>
<p>在将数据<code>push</code>存储进队列之后，我们将会异步调用<code>performWork()</code>。</p>
<h3 id="performWork-amp-amp-workLoop"><a href="#performWork-amp-amp-workLoop" class="headerlink" title="performWork() &amp;&amp; workLoop()"></a>performWork() &amp;&amp; workLoop()</h3><p><img src="../images/fiber_performWork_workLoop.png" alt="fiber_performWork_workLoop"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ENOUGH_TIME = <span class="number">1</span>; <span class="comment">// milliseconds</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performWork</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">  workLoop(deadline);</span><br><span class="line">  <span class="keyword">if</span> (nextUnitOfWork || updateQueue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    requestIdleCallback(performWork);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoop</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!nextUnitOfWork) &#123;</span><br><span class="line">    resetNextUnitOfWork();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; ENOUGH_TIME) &#123;</span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (pendingCommit) &#123;</span><br><span class="line">    commitAllWork(pendingCommit);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了我们之前看到的<code>performUnitOfWork</code>模式。</p>
<p><code>workLoop()</code>中判断deadline是不是有足够的时间来运行代码，如果不够，停止循环，回到<code>performWork()</code>，并且<code>nextUnitOfWork</code>还被保留为下次任务，在<code>performWork()</code>中判断是否还需要执行。</p>
<p><code>performUnitOfWork()</code>的作用是构建 work-in-progress tree和找到哪些需要操作DOM的改变。这种处理方式是递增的，一次只处理一个fiber。</p>
<p>如果<code>performUnitOfWork()</code>完成了本次更新的所有工作，则renturn值为null，并且调用<code>commitAllWork</code>改变DOM。</p>
<p>至今为止，我们还没有看到第一个<code>nextUnitOfWork</code>是如何产生的</p>
<h3 id="resetUnitOfWork"><a href="#resetUnitOfWork" class="headerlink" title="resetUnitOfWork()"></a>resetUnitOfWork()</h3><p><img src="../images/fiber_resetUnitOfWork.png" alt="fiber_resetUnitOfWork"></p>
<p>函数取出<code>updateQueue</code>第一项，将其转换成<code>nextUnitOfWork</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetNextUnitOfWork</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> update = updateQueue.shift();</span><br><span class="line">  <span class="keyword">if</span> (!update) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Copy the setState parameter from the update payload to the corresponding fiber</span></span><br><span class="line">  <span class="keyword">if</span> (update.partialState) &#123;</span><br><span class="line">    update.instance.__fiber.partialState = update.partialState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root =</span><br><span class="line">    update.from == HOST_ROOT</span><br><span class="line">      ? update.dom._rootContainerFiber</span><br><span class="line">      : getRoot(update.instance.__fiber);</span><br><span class="line"></span><br><span class="line">  nextUnitOfWork = &#123;</span><br><span class="line">    tag: HOST_ROOT,</span><br><span class="line">    stateNode: update.dom || root.stateNode,</span><br><span class="line">    props: update.newProps || root.props,</span><br><span class="line">    alternate: root</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRoot</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> node = fiber;</span><br><span class="line">  <span class="keyword">while</span> (node.parent) &#123;</span><br><span class="line">    node = node.parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果update包含<code>partialState</code>, 就将其保存的对应fiber上，在后面会赋值给组件实例，已供render使用。</p>
<p>然后，我们找到old fiber树的根节点。如果update是first render调用的，root fiber将为null。如果是之后的render，root将等于<code>_rootContainerFiber</code>。如果update是因为<code>setState()</code>，则向上找到第一个没有patient属性的fiber。</p>
<p>然后我们将其赋值给<code>nextUnitOfWork</code>，注意，这个fiber将会是work-in-progress的根元素。</p>
<p>如果没有old root。stateNode将取render()中的参数。props将会是render()的另外一个参数。props中children是数组。<code>alternate</code>是 null。</p>
<p>如果有old root。stateNode是之前的root DOM node。props将会是newProps，如果其值不为null的话，否则就是原来的props。<code>alternate</code>就是之前的old root。</p>
<p>我们现在已经有了work-in-progress的根元素，让我们构造剩下的吧</p>
<h3 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork()"></a>performUnitOfWork()</h3><p><img src="../images/fiber_performUnitOfWork.png" alt="fiber_performUnitOfWork"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">wipFiber</span>) </span>&#123;</span><br><span class="line">  beginWork(wipFiber);</span><br><span class="line">  <span class="keyword">if</span> (wipFiber.child) &#123;</span><br><span class="line">    <span class="keyword">return</span> wipFiber.child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// No child, we call completeWork until we find a sibling</span></span><br><span class="line">  <span class="keyword">let</span> uow = wipFiber;</span><br><span class="line">  <span class="keyword">while</span> (uow) &#123;</span><br><span class="line">    completeWork(uow);</span><br><span class="line">    <span class="keyword">if</span> (uow.sibling) &#123;</span><br><span class="line">      <span class="comment">// Sibling needs to beginWork</span></span><br><span class="line">      <span class="keyword">return</span> uow.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    uow = uow.parent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>performUnitOfWork()</code> 遍历work-in-progress树</p>
<p><code>beginWork()</code>的作用是创建子节点的fiber。并且将第一次子节点作为fiber的child属性</p>
<p>如果当前fiber没有子节点，我们就调用<code>completeWork()</code>，并且返回<code>sibling</code>作为下一个<code>nextUnitOfWork</code>.</p>
<p>如果没有<code>sibling</code>，就继续向上操作parent fiber。直到root。</p>
<p>总的来说，就是先处理叶子节点，然后是其兄弟节点，然后是双亲节点。从下往上遍历。</p>
<h3 id="beginWork-updateHostComponent-updateClassComponent"><a href="#beginWork-updateHostComponent-updateClassComponent" class="headerlink" title="beginWork(), updateHostComponent(), updateClassComponent()"></a>beginWork(), updateHostComponent(), updateClassComponent()</h3><p><img src="../images/fiber_beginWork.png" alt="beginWork"><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">unction beginWork(wipFiber) &#123;</span><br><span class="line">  <span class="keyword">if</span> (wipFiber.tag == CLASS_COMPONENT) &#123;</span><br><span class="line">    updateClassComponent(wipFiber);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateHostComponent(wipFiber);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostComponent</span>(<span class="params">wipFiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!wipFiber.stateNode) &#123;</span><br><span class="line">    wipFiber.stateNode = createDomElement(wipFiber);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> newChildElements = wipFiber.props.children;</span><br><span class="line">  reconcileChildrenArray(wipFiber, newChildElements);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClassComponent</span>(<span class="params">wipFiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> instance = wipFiber.stateNode;</span><br><span class="line">  <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Call class constructor</span></span><br><span class="line">    instance = wipFiber.stateNode = createInstance(wipFiber);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wipFiber.props == instance.props &amp;&amp; !wipFiber.partialState) &#123;</span><br><span class="line">    <span class="comment">// No need to render, clone children from last time</span></span><br><span class="line">    cloneChildFibers(wipFiber);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  instance.props = wipFiber.props;</span><br><span class="line">  instance.state = <span class="built_in">Object</span>.assign(&#123;&#125;, instance.state, wipFiber.partialState);</span><br><span class="line">  wipFiber.partialState = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newChildElements = wipFiber.stateNode.render();</span><br><span class="line">  reconcileChildrenArray(wipFiber, newChildElements);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>beginWork()</code>的作用有两个</p>
<ul>
<li>创建 stateNode</li>
<li>拿到component children，并且调用 <code>reconcileChildrenArray()</code></li>
</ul>
<p>因为对不同类型component的处理方式不同， 这里分成了<code>updateHostComponent</code>， <code>updateClassComponent</code>两个函数。</p>
<p><code>updateHostComponennt</code> 处理了host component 和 root component。如果fiber上没有DOM node则新建一个（仅仅是创建一个DOM节点，没有子节点，也没有插入到DOM中）。然后利用fiber props中的children去调用<code>reconcileChildrenArray()</code></p>
<p><code>updateClassComponent</code> 处理了用户创建的class component。如果没有实例则创建一个。并且更新了props和state，这样render就是可以计算出新的children。</p>
<p><code>updateClassComponent</code>并不是每次都调用render函数。这有点类似于<code>shouldCompnentUpdate</code>函数。如果不需要调用render，就复制子节点。</p>
<p>现在我们有了<code>newChildElements</code>， 我们已经准备好去创建child fiber。</p>
<h3 id="reconcileChildrenArray"><a href="#reconcileChildrenArray" class="headerlink" title="reconcileChildrenArray()"></a>reconcileChildrenArray()</h3><p><img src="../images/fiber_reconcileChildrenArray.png" alt="reconcileChildrenArray"></p>
<p>注意，这里是核心。这里创建了work-in-progress 树和决定如何更新DOM</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/ Effect tags</span><br><span class="line"><span class="keyword">const</span> PLACEMENT = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> DELETION = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> UPDATE = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arrify</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> val == <span class="literal">null</span> ? [] : <span class="built_in">Array</span>.isArray(val) ? val : [val];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildrenArray</span>(<span class="params">wipFiber, newChildElements</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> elements = arrify(newChildElements);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> oldFiber = wipFiber.alternate ? wipFiber.alternate.child : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> newFiber = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.length || oldFiber != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevFiber = newFiber;</span><br><span class="line">    <span class="keyword">const</span> element = index &lt; elements.length &amp;&amp; elements[index];</span><br><span class="line">    <span class="keyword">const</span> sameType = oldFiber &amp;&amp; element &amp;&amp; element.type == oldFiber.type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sameType) &#123;</span><br><span class="line">      newFiber = &#123;</span><br><span class="line">        type: oldFiber.type,</span><br><span class="line">        tag: oldFiber.tag,</span><br><span class="line">        stateNode: oldFiber.stateNode,</span><br><span class="line">        props: element.props,</span><br><span class="line">        parent: wipFiber,</span><br><span class="line">        alternate: oldFiber,</span><br><span class="line">        partialState: oldFiber.partialState,</span><br><span class="line">        effectTag: UPDATE</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element &amp;&amp; !sameType) &#123;</span><br><span class="line">      newFiber = &#123;</span><br><span class="line">        type: element.type,</span><br><span class="line">        tag:</span><br><span class="line">          <span class="keyword">typeof</span> element.type === <span class="string">"string"</span> ? HOST_COMPONENT : CLASS_COMPONENT,</span><br><span class="line">        props: element.props,</span><br><span class="line">        parent: wipFiber,</span><br><span class="line">        effectTag: PLACEMENT</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber &amp;&amp; !sameType) &#123;</span><br><span class="line">      oldFiber.effectTag = DELETION;</span><br><span class="line">      wipFiber.effects = wipFiber.effects || [];</span><br><span class="line">      wipFiber.effects.push(oldFiber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber) &#123;</span><br><span class="line">      oldFiber = oldFiber.sibling;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">      wipFiber.child = newFiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevFiber &amp;&amp; element) &#123;</span><br><span class="line">      prevFiber.sibling = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先我们确定<code>newChildElements</code>是一个数组（并不像之前的diff算法，这次的算法的children总是数组，这意味着我们可以在render中返回数组）</p>
<p>然后,开始将old fiber中的children与新的elements做对比。还记得吗？fiber.alternate就是old fiber。new elements 来自于<code>props.children</code>（function）和 <code>render</code>(Class Component)。</p>
<p>reconciliation算法首先diff wipFiber.alternate.child 和 elements[0]，然后是 wipFiber.alternate.child.sibling 和 elements[1]。这样一直遍历到遍历结束。</p>
<ul>
<li>如果<code>oldFiber</code>和<code>element</code>有相同的type。就通过old fiber创建新的。注意增加了<code>UPDATE effectTag</code></li>
<li>如果这两者有不同的type或者没有对应的oldFiber（因为我们新添加了子节点）,就创建新的fiber。注意新fiber不会有<code>alternate</code>属性和stateNode（stateNode就会在<code>beginWork()</code>中创建）。还增加了<code>PLACEMENT effectTag</code>。</li>
<li>如果这两者有不同的type或者没有对应的<code>element</code>（因为我们删除了一些子节点）。我们标记old fiber <code>DELETION</code>。</li>
</ul>
<h3 id="cloneChildFibers"><a href="#cloneChildFibers" class="headerlink" title="cloneChildFibers()"></a>cloneChildFibers()</h3><p><img src="../images/fiber_cloneChildFibers.png" alt="cloneChildFibers"></p>
<p><code>updateClassComponent</code>中有一个特殊情况，就是不需要render，而是直接复制fiber。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneChildFibers</span>(<span class="params">parentFiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> oldFiber = parentFiber.alternate;</span><br><span class="line">  <span class="keyword">if</span> (!oldFiber.child) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> oldChild = oldFiber.child;</span><br><span class="line">  <span class="keyword">let</span> prevChild = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">while</span> (oldChild) &#123;</span><br><span class="line">    <span class="keyword">const</span> newChild = &#123;</span><br><span class="line">      type: oldChild.type,</span><br><span class="line">      tag: oldChild.tag,</span><br><span class="line">      stateNode: oldChild.stateNode,</span><br><span class="line">      props: oldChild.props,</span><br><span class="line">      partialState: oldChild.partialState,</span><br><span class="line">      alternate: oldChild,</span><br><span class="line">      parent: parentFiber</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (prevChild) &#123;</span><br><span class="line">      prevChild.sibling = newChild;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      parentFiber.child = newChild;</span><br><span class="line">    &#125;</span><br><span class="line">    prevChild = newChild;</span><br><span class="line">    oldChild = oldChild.sibling;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>cloneChildFibers()</code>拷贝了old fiber的所有的子fiber。我们不需要增加<code>effectTag</code>，因为我们确定不需要改变什么。</p>
<h3 id="completeWork"><a href="#completeWork" class="headerlink" title="completeWork()"></a>completeWork()</h3><p><img src="../images/fiber_completeWork.png" alt="fiber_completeWork"></p>
<p><code>performUnitOfWork</code>, 当wipFiber 没有新的子节点，或者我们已经处理了所有的子节点时，我们调用<code>completeWork</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fiber.tag == CLASS_COMPONENT) &#123;</span><br><span class="line">    fiber.stateNode.__fiber = fiber;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.parent) &#123;</span><br><span class="line">    <span class="keyword">const</span> childEffects = fiber.effects || [];</span><br><span class="line">    <span class="keyword">const</span> thisEffect = fiber.effectTag != <span class="literal">null</span> ? [fiber] : [];</span><br><span class="line">    <span class="keyword">const</span> parentEffects = fiber.parent.effects || [];</span><br><span class="line">    fiber.parent.effects = parentEffects.concat(childEffects, thisEffect);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pendingCommit = fiber;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>completeWork</code> 中，我们新建了effects列表。其中包含了work-in-progress中所有包含<code>effecTag</code>。方便后面处理。最后我们将pendingCommit指向了root fiber。并且在<code>workLoop</code>中使用。</p>
<h3 id="commitAllWork-amp-commitWork"><a href="#commitAllWork-amp-commitWork" class="headerlink" title="commitAllWork &amp; commitWork"></a>commitAllWork &amp; commitWork</h3><p><img src="../images/fiber_commitAllWork.png" alt="commitAllWork"></p>
<p>这是最后一件我们需要做的事情，改变DOM。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitAllWork</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  fiber.effects.forEach(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">    commitWork(f);</span><br><span class="line">  &#125;);</span><br><span class="line">  fiber.stateNode._rootContainerFiber = fiber;</span><br><span class="line">  nextUnitOfWork = <span class="literal">null</span>;</span><br><span class="line">  pendingCommit = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitWork</span>(<span class="params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fiber.tag == HOST_ROOT) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> domParentFiber = fiber.parent;</span><br><span class="line">  <span class="keyword">while</span> (domParentFiber.tag == CLASS_COMPONENT) &#123;</span><br><span class="line">    domParentFiber = domParentFiber.parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> domParent = domParentFiber.stateNode;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.effectTag == PLACEMENT &amp;&amp; fiber.tag == HOST_COMPONENT) &#123;</span><br><span class="line">    domParent.appendChild(fiber.stateNode);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.effectTag == UPDATE) &#123;</span><br><span class="line">    updateDomProperties(fiber.stateNode, fiber.alternate.props, fiber.props);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.effectTag == DELETION) &#123;</span><br><span class="line">    commitDeletion(fiber, domParent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitDeletion</span>(<span class="params">fiber, domParent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> node = fiber;</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.tag == CLASS_COMPONENT) &#123;</span><br><span class="line">      node = node.child;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    domParent.removeChild(node.stateNode);</span><br><span class="line">    <span class="keyword">while</span> (node != fiber &amp;&amp; !node.sibling) &#123;</span><br><span class="line">      node = node.parent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node == fiber) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    node = node.sibling;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>commitAllWork</code>首先遍历了所有的根root effects。</p>
<ul>
<li>PLACEMENT。将dom插入到父节点上</li>
<li>UPDATE。将新旧props交给<code>updateDomProperties()</code>处理。</li>
<li>DELETION。如果是Host component。用removeChild()删除就好。如果是class Component，那就要删除fiber subTree下面的所有host Component。</li>
</ul>
<p>一旦我们完成了所有的effects，就重置<code>nextUnitOfWork</code>和<code>pendingCommit</code>。work-in-progress tree就变成了old tree。并复制给<code>_rootContainerFiber</code>。<br>这样我们完成了更新，并且做好了等待下一次更新的准备。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2018/10/21/200行代码react（译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/21/200行代码react（译）/" itemprop="url">200行代码react（译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-21T11:21:20+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/21/200行代码react（译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/10/21/200行代码react（译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="babel"><a href="#babel" class="headerlink" title="babel"></a>babel</h3><p>在runtime时, babel转译器将对每一个节点都执行在编译注释(Pragma)中声明的函数。<br>例如：</p>
<h3 id="before-babel：-the-code-you-write"><a href="#before-babel：-the-code-you-write" class="headerlink" title="before babel： (the code you write)"></a>before babel： (the code you write)</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @jsx h */</span></span><br><span class="line"><span class="keyword">let</span> foo = &lt;div id="foo"&gt;Hello!&lt;/div&gt;;</span><br></pre></td></tr></table></figure>
<h3 id="after-babel：-the-code-you-run"><a href="#after-babel：-the-code-you-run" class="headerlink" title="after babel： (the code you run)"></a>after babel： (the code you run)</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = h(<span class="string">'div'</span>, &#123;<span class="attr">id</span>:<span class="string">"foo"</span>&#125;, <span class="string">'Hello!'</span>);</span><br></pre></td></tr></table></figure>
<p>也可以在浏览器里打印看一下结果：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/babel-standalone@6/babel.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/jsx"</span> <span class="attr">data-presets</span>=<span class="string">"es2016,react"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">/** @jsx h */</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> foo = <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"foo"</span>&gt;</span>Hello!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> h = <span class="function">(<span class="params">type, attributes, ...args</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> children = args.length ? [].concat(...args) : <span class="literal">null</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> &#123; nodeName, attributes, children &#125;;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(foo);</span></span><br><span class="line"><span class="javascript">    <span class="comment">// foo: &#123;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//   attributes: &#123;id: "foo"&#125;</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//   children: ["Hello!"]</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//   nodeName: "div"</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h3><p>将jsx中的element转换成 plain object<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, ...args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> props = <span class="built_in">Object</span>.assign(&#123;&#125;, config);</span><br><span class="line">  <span class="keyword">const</span> hasChildren = args.length &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> rawChildren = hasChildren ? [].concat(...args) : [];</span><br><span class="line">  props.children = rawChildren</span><br><span class="line">    .filter(<span class="function"><span class="params">c</span> =&gt;</span> c != <span class="literal">null</span> &amp;&amp; c !== <span class="literal">false</span>)</span><br><span class="line">    .map(<span class="function"><span class="params">c</span> =&gt;</span> c <span class="keyword">instanceof</span> <span class="built_in">Object</span> ? c : createTextElement(c));</span><br><span class="line">  <span class="keyword">return</span> &#123; type, props &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTextElement</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createElement(TEXT_ELEMENT, &#123; <span class="attr">nodeValue</span>: value &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里对text node特殊处理了一下，使其不那么特殊, 如此后面处理时省略了许多判断</p>
<h3 id="instance"><a href="#instance" class="headerlink" title="instance"></a>instance</h3><p>每个element（jsx转换而来的）对应一个instance，instance包含了dom, element, childInstances。<br>如果是custom component 则还有一个publicInstance，是组件的实例.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">instantiate</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type, props &#125; = element;</span><br><span class="line">  <span class="keyword">const</span> isDomElement = <span class="keyword">typeof</span> type === <span class="string">"string"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里对custom component与built-in component分别做处理</span></span><br><span class="line">  <span class="keyword">if</span> (isDomElement) &#123;</span><br><span class="line">    <span class="keyword">const</span> isTextElement = type === TEXT_ELEMENT;</span><br><span class="line">    <span class="keyword">const</span> dom = isTextElement</span><br><span class="line">      ? <span class="built_in">document</span>.createTextNode(<span class="string">""</span>)</span><br><span class="line">      : <span class="built_in">document</span>.createElement(type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// updateDomProperties 作用是更新dom上的属性，比如class、id、或者删除新增事件监听函数等</span></span><br><span class="line">    updateDomProperties(dom, [], props);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理子组件</span></span><br><span class="line">    <span class="keyword">const</span> childElements = props.children || [];</span><br><span class="line">    <span class="keyword">const</span> childInstances = childElements.map(instantiate);</span><br><span class="line">    <span class="keyword">const</span> childDoms = childInstances.map(<span class="function"><span class="params">childInstance</span> =&gt;</span> childInstance.dom);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将子组件的实例插入到dom上</span></span><br><span class="line">    childDoms.forEach(<span class="function"><span class="params">childDom</span> =&gt;</span> dom.appendChild(childDom));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instance = &#123; dom, element, childInstances &#125;;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> instance = &#123;&#125;;</span><br><span class="line">    <span class="comment">// 或者custom-component 实例</span></span><br><span class="line">    <span class="keyword">const</span> publicInstance = createPublicInstance(element, instance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用render方法，获得子组件，再获取child instance.</span></span><br><span class="line">    <span class="comment">// 注意这里是childInstance而不是childInstances，因为custom component只能一个子组件，不能是数组</span></span><br><span class="line">    <span class="keyword">const</span> childElement = publicInstance.render();</span><br><span class="line">    <span class="keyword">const</span> childInstance = instantiate(childElement);</span><br><span class="line">    <span class="keyword">const</span> dom = childInstance.dom;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.assign(instance, &#123; dom, element, childInstance, publicInstance &#125;);</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createPublicInstance"><a href="#createPublicInstance" class="headerlink" title="createPublicInstance"></a>createPublicInstance</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPublicInstance</span>(<span class="params">element, internalInstance</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type, props &#125; = element;</span><br><span class="line">  <span class="keyword">const</span> publicInstance = <span class="keyword">new</span> type(props);</span><br><span class="line"></span><br><span class="line">  publicInstance.__internalInstance = internalInstance;</span><br><span class="line">  <span class="keyword">return</span> publicInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的internalInstance其实就是 instance，之所以需要将其绑定到组件实例上是因为<br>在自定义组件中update需要用到，这里可以先看一下Component的setState实现<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">setState(partialState) &#123;</span><br><span class="line">  <span class="keyword">this</span>.state = <span class="built_in">Object</span>.assign(&#123;&#125;, <span class="keyword">this</span>.state, partialState);</span><br><span class="line">  updateInstance(<span class="keyword">this</span>.__internalInstance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateInstance</span>(<span class="params">internalInstance</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> parentDom = internalInstance.dom.parentNode;</span><br><span class="line">  <span class="keyword">const</span> element = internalInstance.element;</span><br><span class="line">  reconcile(parentDom, internalInstance, element);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="reconciliation-对组件进行-diff"><a href="#reconciliation-对组件进行-diff" class="headerlink" title="reconciliation 对组件进行 diff"></a>reconciliation 对组件进行 diff</h3><p>下面instance是当前的状态，而element是新的状态，将这两者进行diff，就可以得出如何更新dom节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcile</span>(<span class="params">parentDom, instance, element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 不存在instance则创建一个</span></span><br><span class="line">    <span class="keyword">const</span> newInstance = instantiate(element);</span><br><span class="line">    parentDom.appendChild(newInstance.dom);</span><br><span class="line">    <span class="keyword">return</span> newInstance;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 不存在element说明该element已经被删除</span></span><br><span class="line">    parentDom.removeChild(instance.dom);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance.element.type !== element.type) &#123;</span><br><span class="line">    <span class="comment">// 如果新旧element类型不同则替换</span></span><br><span class="line">    <span class="keyword">const</span> newInstance = instantiate(element);</span><br><span class="line">    parentDom.replaceChild(newInstance.dom, instance.dom);</span><br><span class="line">    <span class="keyword">return</span> newInstance;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> element.type === <span class="string">"string"</span>) &#123;</span><br><span class="line">    <span class="comment">// build-in component 更新属性</span></span><br><span class="line">    updateDomProperties(instance.dom, instance.element.props, element.props);</span><br><span class="line">    instance.childInstances = reconcileChildren(instance, element);</span><br><span class="line">    instance.element = element;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新custom component的属性</span></span><br><span class="line">    instance.publicInstance.props = element.props;</span><br><span class="line">    <span class="keyword">const</span> childElement = instance.publicInstance.render();</span><br><span class="line">    <span class="keyword">const</span> oldChildInstance = instance.childInstance;</span><br><span class="line">    <span class="keyword">const</span> childInstance = reconcile(</span><br><span class="line">      parentDom,</span><br><span class="line">      oldChildInstance,</span><br><span class="line">      childElement</span><br><span class="line">    );</span><br><span class="line">    instance.dom = childInstance.dom;</span><br><span class="line">    instance.childInstance = childInstance;</span><br><span class="line">    instance.element = element;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params">instance, element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dom = instance.dom;</span><br><span class="line">  <span class="keyword">const</span> childInstances = instance.childInstances;</span><br><span class="line">  <span class="keyword">const</span> nextChildElements = element.props.children || [];</span><br><span class="line">  <span class="keyword">const</span> newChildInstances = [];</span><br><span class="line">  <span class="keyword">const</span> count = <span class="built_in">Math</span>.max(childInstances.length, nextChildElements.length);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> childInstance = childInstances[i];</span><br><span class="line">    <span class="keyword">const</span> childElement = nextChildElements[i];</span><br><span class="line">    <span class="keyword">const</span> newChildInstance = reconcile(dom, childInstance, childElement);</span><br><span class="line">    newChildInstances.push(newChildInstance);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 过滤掉已经被删除的element</span></span><br><span class="line">  <span class="keyword">return</span> newChildInstances.filter(<span class="function"><span class="params">instance</span> =&gt;</span> instance != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h3><p>由于之前已经讲过了setState，其他部分就很简单了<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">this</span>.props = props;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">this</span>.state || &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(partialState) &#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="built_in">Object</span>.assign(&#123;&#125;, <span class="keyword">this</span>.state, partialState);</span><br><span class="line">    updateInstance(<span class="keyword">this</span>.__internalInstance);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="render"><a href="#render" class="headerlink" title="render"></a>render</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container</span>) </span>&#123;</span><br><span class="line">  reconcile(container, <span class="literal">null</span>, element);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一个完整的例子"><a href="#一个完整的例子" class="headerlink" title="一个完整的例子"></a>一个完整的例子</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/babel-standalone@6/babel.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/jsx"</span> <span class="attr">data-presets</span>=<span class="string">"es2016,react"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">/** @jsx Didact.createElement */</span></span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> Didact = importFromBelow();</span></span><br><span class="line"><span class="javascript">    <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Didact</span>.<span class="title">Component</span> </span>&#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">constructor</span>(props) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">super</span>(props);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.state = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      add = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.setState(&#123;</span></span><br><span class="line"><span class="javascript">          count: <span class="keyword">this</span>.state.count + <span class="number">1</span>,</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      render() &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>count: &#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.add&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="undefined">        );</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    <span class="class"><span class="keyword">class</span> <span class="title">Button</span> <span class="keyword">extends</span> <span class="title">Didact</span>.<span class="title">Component</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">      render() &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> &#123; onClick &#125; = <span class="keyword">this</span>.props;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> (</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;onClick&#125;</span>&gt;</span>add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="undefined">        );</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    Didact.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, document.getElementById("root"));</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">importFromBelow</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> rootInstance = <span class="literal">null</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> TEXT_ELEMENT = <span class="string">"TEXT_ELEMENT"</span>;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, ...args</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> props = <span class="built_in">Object</span>.assign(&#123;&#125;, config);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> hasChildren = args.length &gt; <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> rawChildren = hasChildren ? [].concat(...args) : [];</span></span><br><span class="line"><span class="undefined">        props.children = rawChildren</span></span><br><span class="line"><span class="javascript">          .filter(<span class="function"><span class="params">c</span> =&gt;</span> c != <span class="literal">null</span> &amp;&amp; c !== <span class="literal">false</span>)</span></span><br><span class="line"><span class="javascript">          .map(<span class="function"><span class="params">c</span> =&gt;</span> c <span class="keyword">instanceof</span> <span class="built_in">Object</span> ? c : createTextElement(c));</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123; type, props &#125;;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">createTextElement</span>(<span class="params">value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> createElement(TEXT_ELEMENT, &#123; <span class="attr">nodeValue</span>: value &#125;);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> prevInstance = rootInstance;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> nextInstance = reconcile(container, prevInstance, element);</span></span><br><span class="line"><span class="undefined">        rootInstance = nextInstance;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">reconcile</span>(<span class="params">parentDom, instance, element</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> newInstance = instantiate(element);</span></span><br><span class="line"><span class="undefined">          parentDom.appendChild(newInstance.dom);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> newInstance;</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element == <span class="literal">null</span>) &#123;</span></span><br><span class="line"><span class="undefined">          parentDom.removeChild(instance.dom);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> <span class="literal">null</span>;</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance.element.type !== element.type) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> newInstance = instantiate(element);</span></span><br><span class="line"><span class="undefined">          parentDom.replaceChild(newInstance.dom, instance.dom);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> newInstance;</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> element.type === <span class="string">"string"</span>) &#123;</span></span><br><span class="line"><span class="undefined">          updateDomProperties(instance.dom, instance.element.props, element.props);</span></span><br><span class="line"><span class="undefined">          instance.childInstances = reconcileChildren(instance, element);</span></span><br><span class="line"><span class="undefined">          instance.element = element;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> instance;</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">          instance.publicInstance.props = element.props;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childElement = instance.publicInstance.render();</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> oldChildInstance = instance.childInstance;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childInstance = reconcile(</span></span><br><span class="line"><span class="undefined">            parentDom,</span></span><br><span class="line"><span class="undefined">            oldChildInstance,</span></span><br><span class="line"><span class="undefined">            childElement</span></span><br><span class="line"><span class="undefined">          );</span></span><br><span class="line"><span class="undefined">          instance.dom = childInstance.dom;</span></span><br><span class="line"><span class="undefined">          instance.childInstance = childInstance;</span></span><br><span class="line"><span class="undefined">          instance.element = element;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> instance;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params">instance, element</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> dom = instance.dom;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> childInstances = instance.childInstances;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> nextChildElements = element.props.children || [];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> newChildInstances = [];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> count = <span class="built_in">Math</span>.max(childInstances.length, nextChildElements.length);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childInstance = childInstances[i];</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childElement = nextChildElements[i];</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> newChildInstance = reconcile(dom, childInstance, childElement);</span></span><br><span class="line"><span class="undefined">          newChildInstances.push(newChildInstance);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> newChildInstances.filter(<span class="function"><span class="params">instance</span> =&gt;</span> instance != <span class="literal">null</span>);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">instantiate</span>(<span class="params">element</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> &#123; type, props &#125; = element;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> isDomElement = <span class="keyword">typeof</span> type === <span class="string">"string"</span>;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (isDomElement) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> isTextElement = type === TEXT_ELEMENT;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> dom = isTextElement</span></span><br><span class="line"><span class="javascript">            ? <span class="built_in">document</span>.createTextNode(<span class="string">""</span>)</span></span><br><span class="line"><span class="javascript">            : <span class="built_in">document</span>.createElement(type);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">          updateDomProperties(dom, [], props);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childElements = props.children || [];</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childInstances = childElements.map(instantiate);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childDoms = childInstances.map(<span class="function"><span class="params">childInstance</span> =&gt;</span> childInstance.dom);</span></span><br><span class="line"><span class="javascript">          childDoms.forEach(<span class="function"><span class="params">childDom</span> =&gt;</span> dom.appendChild(childDom));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> instance = &#123; dom, element, childInstances &#125;;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> instance;</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> instance = &#123;&#125;;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> publicInstance = createPublicInstance(element, instance);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childElement = publicInstance.render();</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> childInstance = instantiate(childElement);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> dom = childInstance.dom;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">          <span class="built_in">Object</span>.assign(instance, &#123; dom, element, childInstance, publicInstance &#125;);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">return</span> instance;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">updateDomProperties</span>(<span class="params">dom, prevProps, nextProps</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> isEvent = <span class="function"><span class="params">name</span> =&gt;</span> name.startsWith(<span class="string">"on"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> isAttribute = <span class="function"><span class="params">name</span> =&gt;</span> !isEvent(name) &amp;&amp; name != <span class="string">"children"</span>;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">        <span class="built_in">Object</span>.keys(prevProps).filter(isEvent).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> eventType = name.toLowerCase().substring(<span class="number">2</span>);</span></span><br><span class="line"><span class="undefined">          dom.removeEventListener(eventType, prevProps[name]);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">        <span class="built_in">Object</span>.keys(prevProps).filter(isAttribute).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          dom[name] = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">        <span class="built_in">Object</span>.keys(nextProps).filter(isAttribute).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">          dom[name] = nextProps[name];</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">        <span class="built_in">Object</span>.keys(nextProps).filter(isEvent).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> eventType = name.toLowerCase().substring(<span class="number">2</span>);</span></span><br><span class="line"><span class="undefined">          dom.addEventListener(eventType, nextProps[name]);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">createPublicInstance</span>(<span class="params">element, internalInstance</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> &#123; type, props &#125; = element;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> publicInstance = <span class="keyword">new</span> type(props);</span></span><br><span class="line"><span class="undefined">        publicInstance.__internalInstance = internalInstance;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> publicInstance;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">constructor</span>(props) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">this</span>.props = props;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">this</span>.state = <span class="keyword">this</span>.state || &#123;&#125;;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="undefined">        setState(partialState) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">this</span>.state = <span class="built_in">Object</span>.assign(&#123;&#125;, <span class="keyword">this</span>.state, partialState);</span></span><br><span class="line"><span class="javascript">          updateInstance(<span class="keyword">this</span>.__internalInstance);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">updateInstance</span>(<span class="params">internalInstance</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> parentDom = internalInstance.dom.parentNode;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> element = internalInstance.element;</span></span><br><span class="line"><span class="undefined">        reconcile(parentDom, internalInstance, element);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="undefined">        createElement,</span></span><br><span class="line"><span class="undefined">        render,</span></span><br><span class="line"><span class="undefined">        Component</span></span><br><span class="line"><span class="undefined">      &#125;;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文是对文章<a href="https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5" target="_blank" rel="noopener">Didact: a DIY guide to build your own React</a> 的总结。旨在帮助我在阅读react源码之前先整体把握react的结构组成，帮助我更好的阅读源码。由于react16大量更新了代码，引入了Fiber：Incremental reconciliation，下篇看一下fiber的简单的实现。是同一位作者所写。</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://jasonformat.com/wtf-is-jsx/" target="_blank" rel="noopener">wtf-is-jsx</a><br><a href="https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5" target="_blank" rel="noopener">DIY React</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2018/10/07/dva-源码解析-下/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/07/dva-源码解析-下/" itemprop="url">dva-源码解析-下</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-07T22:04:09+08:00">
                2018-10-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/07/dva-源码解析-下/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/10/07/dva-源码解析-下/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先这是一篇找妈妈的故事， model中的state，reducers，effects，是如何找到各自的妈妈呢？23333～</p>
<p>dva 是对redux、react-redux、react-router、redux-saga的整合，所以在看dva源码之前建议先要熟悉这些库的用法。<br>废话不多说，那我们就开始。先看一下生成的 index.js 文件，在这里我加入了dva-loading，用来分析plugin。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dva <span class="keyword">from</span> <span class="string">'dva'</span>;</span><br><span class="line"><span class="keyword">import</span> createLoading <span class="keyword">from</span> <span class="string">'dva-loading'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Initialize</span></span><br><span class="line"><span class="keyword">const</span> app = dva();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Plugins</span></span><br><span class="line">app.use(createLoading());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Model</span></span><br><span class="line">app.model(<span class="built_in">require</span>(<span class="string">'./models/example'</span>).default);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Router</span></span><br><span class="line">app.router(<span class="built_in">require</span>(<span class="string">'./router'</span>).default);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. Start</span></span><br><span class="line">app.start(<span class="string">'#root'</span>);</span><br></pre></td></tr></table></figure></p>
<p>可以看到，dva生成app实例，并且绑定plugin、models、router，最后启动项目。</p>
<p>先去看一下dva的源码，位置是dva/src/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params">opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> history = opts.history || createHashHistory();</span><br><span class="line">  <span class="keyword">const</span> createOpts = &#123;</span><br><span class="line">    initialReducer: &#123;</span><br><span class="line">      routing,</span><br><span class="line">    &#125;,</span><br><span class="line">    setupMiddlewares(middlewares) &#123;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        routerMiddleware(history),</span><br><span class="line">        ...middlewares,</span><br><span class="line">      ];</span><br><span class="line">    &#125;,</span><br><span class="line">    setupApp(app) &#123;</span><br><span class="line">      app._history = patchHistory(history);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> app = core.create(opts, createOpts);</span><br><span class="line">  <span class="keyword">const</span> oldAppStart = app.start;</span><br><span class="line">  app.router = router;</span><br><span class="line">  app.start = start;</span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">router</span>(<span class="params">router</span>) </span>&#123;</span><br><span class="line">    app._router = router;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">container</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 允许 container 是字符串，然后用 querySelector 找元素</span></span><br><span class="line">    <span class="keyword">if</span> (isString(container)) &#123;</span><br><span class="line">      container = <span class="built_in">document</span>.querySelector(container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!app._store) &#123;</span><br><span class="line">      oldAppStart.call(app);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> store = app._store;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If has container, render; else, return react component</span></span><br><span class="line">    <span class="keyword">if</span> (container) &#123;</span><br><span class="line">      render(container, store, app, app._router);</span><br><span class="line">      app._plugin.apply(<span class="string">'onHmr'</span>)(render.bind(<span class="literal">null</span>, container, store, app));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> getProvider(store, <span class="keyword">this</span>, <span class="keyword">this</span>._router);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码重点在两句</p>
<ul>
<li><code>const app = core.create(opts, createOpts);</code> 利用dva-core生成数据层app</li>
<li><code>app.start = start;</code> 由于dva-core仅仅是数据层，所以这里需要代理start方法，建立view层，比如react、router</li>
</ul>
<p>接下来我想会重点分析model方法（这是整个dva的核心部分） 位置是dva-core/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">hooksAndOpts = &#123;&#125;, createOpts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; initialReducer, setupApp = noop &#125; = createOpts;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> plugin = <span class="keyword">new</span> Plugin();</span><br><span class="line">  plugin.use(filterHooks(hooksAndOpts));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> app = &#123;</span><br><span class="line">    _models: [prefixNamespace(&#123; ...dvaModel &#125;)],</span><br><span class="line">    _store: <span class="literal">null</span>,</span><br><span class="line">    _plugin: plugin,</span><br><span class="line">    use: plugin.use.bind(plugin),</span><br><span class="line">    model,</span><br><span class="line">    start,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册model，将model里的reducers与effects方法增加namespace，并且保存在app._models中</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">model</span>(<span class="params">m</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      checkModel(m, app._models);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> prefixedModel = prefixNamespace(&#123; ...m &#125;);</span><br><span class="line">    app._models.push(prefixedModel);</span><br><span class="line">    <span class="keyword">return</span> prefixedModel;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在一个项目中我们会注册多个model，现在models都已经被存在了app_models中。dva是如何将每个model里的state，reducers， effects，<br>放在redux与redux-saga中的呢？答案就在 app.start 里。start里主要是redux和redux-saga的初始化<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reducers = &#123; ...initialReducer &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> m <span class="keyword">of</span> app._models) &#123;</span><br><span class="line">  reducers[m.namespace] = getReducer(</span><br><span class="line">    m.reducers,</span><br><span class="line">    m.state,</span><br><span class="line">    plugin._handleActions</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (m.effects)</span><br><span class="line">    sagas.push(app._getSaga(m.effects, m, onError, plugin.get(<span class="string">'onEffect'</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码遍历models分别将reducers和effects存下来，先看一下reducer的处理<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">getReducer</span>(<span class="params">reducers, state, handleActions</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Support reducer enhancer</span></span><br><span class="line">  <span class="comment">// e.g. reducers: [realReducers, enhancer]</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(reducers)) &#123;</span><br><span class="line">    <span class="keyword">return</span> reducers[<span class="number">1</span>](</span><br><span class="line">      (handleActions || defaultHandleActions)(reducers[<span class="number">0</span>], state)</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (handleActions || defaultHandleActions)(reducers || &#123;&#125;, state);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一般情况下都不会是数组，话说看到这里我才知道原来还可以加一个enhancer。在去看一下<code>defaultHandleActions</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleActions</span>(<span class="params">handlers, defaultState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reducers = <span class="built_in">Object</span>.keys(handlers).map(<span class="function"><span class="params">type</span> =&gt;</span></span><br><span class="line">    handleAction(type, handlers[type])</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> reducer = reduceReducers(...reducers);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">state = defaultState, action</span>) =&gt;</span> reducer(state, action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里遍历了reducers里的每一个key值，并把一个models下的reduers合并为一个。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleAction</span>(<span class="params">actionType, reducer = identify</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type &#125; = action;</span><br><span class="line">    invariant(type, <span class="string">'dispatch: action should be a plain Object with type'</span>);</span><br><span class="line">    <span class="keyword">if</span> (actionType === type) &#123;</span><br><span class="line">      <span class="keyword">return</span> reducer(state, action);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键在于 <code>if (actionType === type)</code>, 判断类型不同就返回state，类似于 switch…case。<br>下面看一下合并reducer的函数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reduceReducers</span>(<span class="params">...reducers</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">previous, current</span>) =&gt;</span></span><br><span class="line">    reducers.reduce(<span class="function">(<span class="params">p, r</span>) =&gt;</span> r(p, current), previous);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的合并方式我是有点不太理解的，<br>这里采用的是reducer1 -&gt; reducer2 -&gt; reducer3,假如有一个action，models里的handleAction要全跑一遍。<br>为什么不直接找到相应键值的reducer运行呢？，reducer已经分析完了然后就是effects<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">getSaga</span>(<span class="params">effects, model, onError, onEffect</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> effects) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Object</span>.prototype.hasOwnProperty.call(effects, key)) &#123;</span><br><span class="line">        <span class="keyword">const</span> watcher = getWatcher(key, effects[key], model, onError, onEffect);</span><br><span class="line">        <span class="keyword">const</span> task = <span class="keyword">yield</span> sagaEffects.fork(watcher);</span><br><span class="line">        <span class="keyword">yield</span> sagaEffects.fork(<span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">yield</span> sagaEffects.take(<span class="string">`<span class="subst">$&#123;model.namespace&#125;</span>/@@CANCEL_EFFECTS`</span>);</span><br><span class="line">          <span class="keyword">yield</span> sagaEffects.cancel(task);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fork每一个effect，然后是 getWatcher 函数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onEffect就是plugin中的OnEffect， 就如开头的那个例子dva-loading中就有一个onEffect</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWatcher</span>(<span class="params">key, _effect, model, onError, onEffect</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 这里给每一个effect增加了开始、结束的事件和错误处理，并且__dva_resolve， __dva_reject是PromiseMiddleware的参数。</span></span><br><span class="line">  <span class="comment">// PromiseMiddleware的作用是当你dispatch effect时，返回一个promise。this.props.dispatch.then这样的写法你一定熟悉。</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>* <span class="title">sagaWithCatch</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">__dva_resolve</span>: resolve = noop, <span class="attr">__dva_reject</span>: reject = noop &#125; =</span><br><span class="line">      args.length &gt; <span class="number">0</span> ? args[<span class="number">0</span>] : &#123;&#125;;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">yield</span> sagaEffects.put(&#123; <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;key&#125;</span><span class="subst">$&#123;NAMESPACE_SEP&#125;</span>@@start`</span> &#125;);</span><br><span class="line">      <span class="comment">// createEffects 封装了redux-saga的effects，主要是改变了type值，这就是你为什么可以在当前model里省略namespace的原因</span></span><br><span class="line">      <span class="keyword">const</span> ret = <span class="keyword">yield</span> effect(...args.concat(createEffects(model)));</span><br><span class="line">      <span class="keyword">yield</span> sagaEffects.put(&#123; <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;key&#125;</span><span class="subst">$&#123;NAMESPACE_SEP&#125;</span>@@end`</span> &#125;);</span><br><span class="line">      resolve(ret);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      onError(e, &#123;</span><br><span class="line">        key,</span><br><span class="line">        effectArgs: args,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (!e._dontReject) &#123;</span><br><span class="line">        reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果插件中有onEffects，则再封装一层</span></span><br><span class="line">  <span class="keyword">const</span> sagaWithOnEffect = applyOnEffect(onEffect, sagaWithCatch, model, key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'watcher'</span>:</span><br><span class="line">      <span class="keyword">return</span> sagaWithCatch;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'takeLatest'</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">yield</span> takeLatest(key, sagaWithOnEffect);</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'throttle'</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">yield</span> throttle(ms, key, sagaWithOnEffect);</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">yield</span> takeEvery(key, sagaWithOnEffect);</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到目前为止我们已经处理好了reduer与effects，接下来就是redux与redux-saga的初始化工作了<br>首先是redux<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = (app._store = createStore(&#123;</span><br><span class="line">  <span class="comment">// eslint-disable-line</span></span><br><span class="line">  reducers: createReducer(),</span><br><span class="line">  initialState: hooksAndOpts.initialState || &#123;&#125;,</span><br><span class="line">  plugin,</span><br><span class="line">  createOpts,</span><br><span class="line">  sagaMiddleware,</span><br><span class="line">  promiseMiddleware,</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>redux-saga<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sagas.forEach(sagaMiddleware.run);</span><br></pre></td></tr></table></figure></p>
<p>ola, dva的源码差不多就到这里了，再去看一个dva-loading是如何工作的。<br>先想一下dva-loading作用是监听effects的开始和结束,并把状态存在store里，那么他肯定需要一个reducer用来存储状态，和effect用来抛出action<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">    global: <span class="literal">false</span>,</span><br><span class="line">    models: &#123;&#125;,</span><br><span class="line">    effects: &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extraReducers = &#123;</span><br><span class="line">  [namespace](state = initialState, &#123; type, payload &#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; namespace, actionType &#125; = payload || &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> ret;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> SHOW:</span><br><span class="line">        ret = &#123;</span><br><span class="line">          ...state,</span><br><span class="line">          global: <span class="literal">true</span>,</span><br><span class="line">          models: &#123; ...state.models, [namespace]: <span class="literal">true</span> &#125;,</span><br><span class="line">          effects: &#123; ...state.effects, [actionType]: <span class="literal">true</span> &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> HIDE: <span class="comment">// eslint-disable-line</span></span><br><span class="line">        res = &#123;...&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        ret = state;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onEffect</span>(<span class="params">effect, &#123; put &#125;, model, actionType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; namespace &#125; = model;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">      (only.length === <span class="number">0</span> &amp;&amp; except.length === <span class="number">0</span>)</span><br><span class="line">      || (only.length &gt; <span class="number">0</span> &amp;&amp; only.indexOf(actionType) !== <span class="number">-1</span>)</span><br><span class="line">      || (except.length &gt; <span class="number">0</span> &amp;&amp; except.indexOf(actionType) === <span class="number">-1</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>*(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: SHOW, <span class="attr">payload</span>: &#123; namespace, actionType &#125; &#125;);</span><br><span class="line">          <span class="keyword">yield</span> effect(...args);</span><br><span class="line">          <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: HIDE, <span class="attr">payload</span>: &#123; namespace, actionType &#125; &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> effect;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>onEffect在之前getWatcher中已经讲过，而extraReducers最后会通过combineReducers合并</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>dva的源码已经分析完了，看完这篇文章相信你已经对dva的工作方式有了大致的了解。下期我会分享react源码。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2018/10/06/dva-源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/06/dva-源码解析/" itemprop="url">dva-源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-06T09:45:12+08:00">
                2018-10-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/06/dva-源码解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/10/06/dva-源码解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="dva-cli"><a href="#dva-cli" class="headerlink" title="dva-cli"></a>dva-cli</h3><p>dva 的命令行工具<br>原理就是当运行 <code>dva new my-app</code> 时，dva-cli 就将其项目中的boilerplates文件夹拷贝到process.cwd()目录下。并且运行<code>npm install</code>安装项目依赖。</p>
<p>查看 package.json 入口在bin/dva<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Notify update when process exits</span></span><br><span class="line"><span class="keyword">const</span> updater = <span class="built_in">require</span>(<span class="string">'update-notifier'</span>);</span><br><span class="line"><span class="keyword">const</span> pkg = <span class="built_in">require</span>(<span class="string">'../package.json'</span>);</span><br><span class="line">updater(&#123; <span class="attr">pkg</span>: pkg &#125;).notify(&#123; <span class="attr">defer</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// dva -v</span></span><br><span class="line"><span class="keyword">if</span> (process.argv.slice(<span class="number">2</span>).join(<span class="string">''</span>) === <span class="string">'-v'</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">program</span><br><span class="line">  .usage(<span class="string">'&lt;command&gt; [options]'</span>)</span><br><span class="line">  .on(<span class="string">'--help'</span>, printHelp)</span><br><span class="line">  .parse(process.argv);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> aliases = &#123;</span><br><span class="line">  g: <span class="string">'generate'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> args = process.argv.slice(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// new、generate</span></span><br><span class="line"><span class="keyword">let</span> subcmd = program.args[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (aliases[subcmd]) subcmd = aliases[subcmd];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!subcmd) &#123;</span><br><span class="line">  program.help();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> bin = executable(subcmd);</span><br><span class="line">  <span class="keyword">if</span> (bin) &#123;</span><br><span class="line">    <span class="comment">// 执行文件</span></span><br><span class="line">    wrap(spawn(bin, args, &#123;<span class="attr">stdio</span>: <span class="string">'inherit'</span>, <span class="attr">customFds</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]&#125;));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    program.help();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrap</span>(<span class="params">sp</span>) </span>&#123;</span><br><span class="line">  sp.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">    process.exit(code);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是不是有相应 subcmd 的执行文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">executable</span>(<span class="params">subcmd</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> file = join(__dirname, <span class="string">'dva-'</span> + subcmd);</span><br><span class="line">  <span class="keyword">if</span> (exists(file)) &#123;</span><br><span class="line">    <span class="keyword">return</span> file;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>bin/dva 是dva-cli的入口文件，其中定义了-v命令以及执行相应的subcmd命令。如果你输入了<code>dva new my-app</code>，那么将会执行bin/dva-new,下面看下bin/dva-new文件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有定义项目名称</span></span><br><span class="line"><span class="keyword">if</span> (!program.args[<span class="number">0</span>]) &#123;</span><br><span class="line">  program.help();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> dest = join(process.cwd(), program.args[<span class="number">0</span>]);</span><br><span class="line">  <span class="comment">// 如果已经存在该项目</span></span><br><span class="line">  <span class="keyword">if</span> (existsSync(dest)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error(<span class="string">'Existing directory here, please run new command for an empty folder!'</span>));</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建目录</span></span><br><span class="line">  mkdirpSync(dest);</span><br><span class="line">  <span class="comment">// 进入目录</span></span><br><span class="line">  process.chdir(dest);</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'../lib/init'</span>)(program);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>bin/dva-new 检查了命令的有效性，并且创建、进入项目目录，执行dva-init初始化项目，下面去看一下bin/dva-init<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">program</span><br><span class="line">  .option(<span class="string">'--demo'</span>, <span class="string">'Generate dva project for demo'</span>)</span><br><span class="line">  .option(<span class="string">'--no-install'</span>, <span class="string">'Install dependencies after boilerplate, default: true'</span>)</span><br><span class="line">  .parse(process.argv);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../lib/init'</span>)(program);</span><br></pre></td></tr></table></figure></p>
<p>定义了两个配置项，然后又调用了lib/init，由于lib文件夹是打包出来的，先去看一下src/init文件吧<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">&#123; demo, install &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = demo ? <span class="string">'demo'</span> : <span class="string">'app'</span>;</span><br><span class="line">  <span class="comment">// __dirname 为执行文件所在的目录</span></span><br><span class="line">  <span class="keyword">const</span> cwd = join(__dirname, <span class="string">'../boilerplates'</span>, type);</span><br><span class="line">  <span class="keyword">const</span> dest = process.cwd();</span><br><span class="line">  <span class="keyword">const</span> projectName = basename(dest);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!emptyDir(dest)) &#123;</span><br><span class="line">    error(<span class="string">'Existing files here, please run init command in an empty folder!'</span>);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Creating a new Dva app in <span class="subst">$&#123;dest&#125;</span>.`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// vfs：文件流处理工具，将boilerplates中的文件拷贝到process.cwd目录下，</span></span><br><span class="line">  <span class="comment">// 如果install为true的话，则执行src/install</span></span><br><span class="line">  vfs.src([<span class="string">'**/*'</span>, <span class="string">'!node_modules/**/*'</span>], &#123;<span class="attr">cwd</span>: cwd, <span class="attr">cwdbase</span>: <span class="literal">true</span>, <span class="attr">dot</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    .pipe(template(dest, cwd))</span><br><span class="line">    .pipe(vfs.dest(dest))</span><br><span class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      info(<span class="string">'rename'</span>, <span class="string">'gitignore -&gt; .gitignore'</span>);</span><br><span class="line">      renameSync(join(dest, <span class="string">'gitignore'</span>), join(dest, <span class="string">'.gitignore'</span>));</span><br><span class="line">      <span class="keyword">if</span> (install) &#123;</span><br><span class="line">        info(<span class="string">'run'</span>, <span class="string">'npm install'</span>);</span><br><span class="line">        <span class="built_in">require</span>(<span class="string">'./install'</span>)(printSuccess);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        printSuccess();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .resume();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">printSuccess</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>src/install 会去根据系统安装的依赖管理工具进行install操作<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好吧 竟然没有yarn</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findNpm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> npms = process.platform === <span class="string">'win32'</span> ? [<span class="string">'tnpm.cmd'</span>, <span class="string">'cnpm.cmd'</span>, <span class="string">'npm.cmd'</span>] : [<span class="string">'tnpm'</span>, <span class="string">'cnpm'</span>, <span class="string">'npm'</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; npms.length; i++) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      which.sync(npms[i]);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'use npm: '</span> + npms[i]);</span><br><span class="line">      <span class="keyword">return</span> npms[i];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'please install npm'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params">done</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> npm = findNpm();</span><br><span class="line">  <span class="comment">// 因为boilerplates/package.json 中没有dva，所以在运行install之后，再安装dva，why？</span></span><br><span class="line">  <span class="comment">// 为什么不干脆将dva写在boilerplates/package.json里呢，</span></span><br><span class="line">  <span class="comment">// 因为这样就可以保证每次安装的dva都是最新版本啊 骚年。</span></span><br><span class="line">  runCmd(which.sync(npm), [<span class="string">'install'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    runCmd(which.sync(npm), [<span class="string">'install'</span>, <span class="string">'dva'</span>, <span class="string">'--save'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(npm + <span class="string">' install end'</span>);</span><br><span class="line">      done();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>在上面我们已经分析了dva new的相关命令，其实dva还支持generate操作（文档上是这么说的），不过。。。我们来看下generate文件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="built_in">console</span>.log(chalk.red(<span class="string">'😢  dva generate is disabled since we don\'t have enough time currently.'</span>));</span><br><span class="line">process.exit(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../lib/generate'</span>)(program, &#123;</span><br><span class="line">  cwd: process.cwd(),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>四个字，暂未开放… 这个文档更新有点落后啊。dva-generate中又依赖了dva-ast 其中主要使用了 <code>facebook/jscodeshift</code>这个库，作用是解析js，将js内容解析成 AST 语法树，然后提供一些便利的操作接口，方便我们对各个节点进行更改，比如更改所有的属性名之类的。感兴趣的同学可以自己去研究一下，就送到这里啦～ dva-cli就分析到这里了，接下来我会去分析dva。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2018/09/26/数据结构与算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/26/数据结构与算法/" itemprop="url">数据结构与算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-26T22:55:28+08:00">
                2018-09-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/26/数据结构与算法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/09/26/数据结构与算法/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="复杂度分析"><a href="#复杂度分析" class="headerlink" title="复杂度分析"></a>复杂度分析</h2><h3 id="为什么要进行复杂度分析"><a href="#为什么要进行复杂度分析" class="headerlink" title="为什么要进行复杂度分析"></a>为什么要进行复杂度分析</h3><ul>
<li>和性能测试相比，有不依赖执行环境、成本低、效率高的特点</li>
<li>掌握复杂度分析，将能编写出性能更高的代码，有利于降低系统开发和维护的成本</li>
</ul>
<h3 id="复杂度分析-1"><a href="#复杂度分析-1" class="headerlink" title="复杂度分析"></a>复杂度分析</h3><ul>
<li>时间复杂度： 不具体表示代码的真正的执行时间，而是表示代码执行时间随数据规模增长的变化趋势</li>
<li>空间复杂度： 代码所占空间随数据规模增长的变化趋势</li>
</ul>
<h4 id="时间复杂度分析"><a href="#时间复杂度分析" class="headerlink" title="时间复杂度分析"></a>时间复杂度分析</h4><ul>
<li><p>加法法则(总复杂度等于量级最大的那段代码的复杂度)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">    sum = sum + i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// var sum = 0; 为常量级的执行时间与n的大小无关</span></span><br><span class="line"><span class="comment">// for 循环 的两行代码需要执行n次，所以这个函数的时间复杂度为O(n)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>乘法法则(嵌套代码的复杂度等于嵌套内外代码的乘积)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cal</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt;= n; j++) &#123;</span><br><span class="line">      res = res + i + j;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// O(n * n) = O(n2)</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="时间复杂度量级-从小到大"><a href="#时间复杂度量级-从小到大" class="headerlink" title="时间复杂度量级 从小到大"></a>时间复杂度量级 从小到大</h4><ul>
<li>O(1)</li>
<li>O(logn)</li>
<li>O(n)</li>
<li>O(nlogn) 归并排序 快速排序</li>
<li>O(n^2), O(n^3)…</li>
<li>O(2^n) 非多项式</li>
<li>O(n!) 非多项式</li>
</ul>
<h4 id="当有多个参数变化时，加法原则就不适用了，但乘法还是适用"><a href="#当有多个参数变化时，加法原则就不适用了，但乘法还是适用" class="headerlink" title="当有多个参数变化时，加法原则就不适用了，但乘法还是适用"></a>当有多个参数变化时，加法原则就不适用了，但乘法还是适用</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cal</span>(<span class="params">m, n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sum(m) + sum(n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 时间复杂度 O(m + n)</span></span><br></pre></td></tr></table></figure>
<h4 id="空间复杂度分析"><a href="#空间复杂度分析" class="headerlink" title="空间复杂度分析"></a>空间复杂度分析</h4><p>时间复杂度会了，空间复杂度很简单</p>
<h3 id="最好情况时间复杂度、最坏情况时间复杂度、平均情况时间复杂度、均摊时间复杂度"><a href="#最好情况时间复杂度、最坏情况时间复杂度、平均情况时间复杂度、均摊时间复杂度" class="headerlink" title="最好情况时间复杂度、最坏情况时间复杂度、平均情况时间复杂度、均摊时间复杂度"></a>最好情况时间复杂度、最坏情况时间复杂度、平均情况时间复杂度、均摊时间复杂度</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">find</span>(<span class="params">array, x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> pos = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (array[i] === x) &#123;</span><br><span class="line">      pos = i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="最好、最坏情况时间复杂度"><a href="#最好、最坏情况时间复杂度" class="headerlink" title="最好、最坏情况时间复杂度"></a>最好、最坏情况时间复杂度</h4><p>这段代码是在array中查找x值。时间复杂度为O(n),如果查找到相等值就立即停止，那么时间复杂度就分两种情况<br>最好情况时间复杂度为O(1)， 最坏情况时间复杂度为O(n)<br>因为x在array中的位置有n+1种可能那么平均时间复杂度为（1+2+3…+n+n）/（n+1），用大O表示法就是O(n),但是这样计算是有些问题的。<br>因为x在数组里和不在数组里的概率都是1/2。所以x出现在0-n-1中任意位置的概率都为1/2n,所以(1+2+3+…n)*1/2n + n*1/2 = (3n + 1) / 4; 结果还是O(n)</p>
<h4 id="均摊时间复杂度-方法：平摊分析"><a href="#均摊时间复杂度-方法：平摊分析" class="headerlink" title="均摊时间复杂度 方法：平摊分析"></a>均摊时间复杂度 方法：平摊分析</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">const</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (count === array.length) &#123;</span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;array.length; i++) &#123;</span><br><span class="line">      sum += array[i];</span><br><span class="line">    &#125;</span><br><span class="line">    array[<span class="number">0</span>] = x;</span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  array[count] = val;</span><br><span class="line">  ++count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当array已满时，对array求和放在开头，然后再insert。<br>最好：O(1)<br>最坏：O(n)<br>平均：O(1)<br>均摊：O(1)，将1次的O(n)操作均摊到n - 1次的O(1)操作中<br>当对一个数据结构进行一组连续的操作时，大部分的情况下时间复杂度都很低，可以利用均摊分析法了。</p>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><h3 id="为什么数组序号从0开始"><a href="#为什么数组序号从0开始" class="headerlink" title="为什么数组序号从0开始"></a>为什么数组序号从0开始</h3><p>数组一个线性表结构。<code>用一组连续的内存空间，来存储一组具有相同类型的数据</code>。这就使得数组支持根据下标随机访问。<br>a[k].address = base.address + k <em> type.size<br>a[k].address = base.address + (k - 1) </em> type.size<br>相比之下，数组序号从1开始会多一次减法运算，再加上c语言采用这种方式，所以。。。</p>
<h3 id="JVM-标记清除垃圾回收算法"><a href="#JVM-标记清除垃圾回收算法" class="headerlink" title="JVM 标记清除垃圾回收算法"></a>JVM 标记清除垃圾回收算法</h3><p>将要释放清除的对象标记，之后再执行清除操作，缺点是会产生内存碎片的问题，很有可能导致下一次分配一块连续较大的内存空间，由于找不到合适的，又触发一次垃圾回收操作。</p>
<h2 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h2><h3 id="约瑟夫问题-可以用循环链表实现"><a href="#约瑟夫问题-可以用循环链表实现" class="headerlink" title="约瑟夫问题 可以用循环链表实现"></a>约瑟夫问题 可以用循环链表实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">n, m</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> s = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">    s = (s + m) % i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>链表练习题：</p>
<ul>
<li>单链表反转</li>
<li>链表中环的检测</li>
<li>两个有序的链表合并</li>
<li>删除链表倒数的第n个节点</li>
<li>求链表的中间节点</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/OPY-bbt/2018/09/26/redux-saga源码解析-下/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="山石岩">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前路漫漫 唯风作伴">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/26/redux-saga源码解析-下/" itemprop="url">redux-saga源码解析-下</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-26T07:34:54+08:00">
                2018-09-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/26/redux-saga源码解析-下/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/09/26/redux-saga源码解析-下/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇文中是对 <a href="">redux-saga源码解析</a> 的补充，可以帮助大家更加全面的了解redux-saga。主要探索一下 <strong>channel</strong>, 和redux-saga中的取消任务<br>想要具体分析一下channel并不是因为多么复杂，而是工作中可能会用到</p>
<h3 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h3><p>在前一篇文章中说到其实redux-saga支持三种channel，分别是channel， eventChannel， multicastChannel。multicastChannel 在前一篇文章已经分析过。这里就看一下另外两个。</p>
<h4 id="channel-1"><a href="#channel-1" class="headerlink" title="channel"></a>channel</h4><p>接受一个buffer对象，返回 channel 对象<br>buffer的作用：当没有任务监听器时，先把事件缓存起来，如果后面有新的任务监听器建立，就立即执行任务。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">channel</span>(<span class="params">buffer = buffers.expanding(</span>)) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> closed = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> takers = []</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果 channel 已经关闭，返回 </span></span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当没有任务监听器时， 缓存在 buffer 里</span></span><br><span class="line">    <span class="keyword">if</span> (takers.length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> buffer.put(input)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正常执行任务</span></span><br><span class="line">    <span class="keyword">const</span> cb = takers.shift()</span><br><span class="line">    cb(input)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">take</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果 channel 已经关闭并且buffer为空，则对任务发送END信号</span></span><br><span class="line">    <span class="comment">// 也可以看出来，即使 channel 关闭，buffer只要不为空，还是可以正常建立任务监听器的</span></span><br><span class="line">    <span class="keyword">if</span> (closed &amp;&amp; buffer.isEmpty()) &#123;</span><br><span class="line">      cb(END)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!buffer.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// buffer不为空的话 直接执行</span></span><br><span class="line">      cb(buffer.take())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 正常建立任务监听器</span></span><br><span class="line">      takers.push(cb)</span><br><span class="line">      cb.cancel = <span class="function"><span class="params">()</span> =&gt;</span> remove(takers, cb)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空buffer里的任务</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flush</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (closed &amp;&amp; buffer.isEmpty()) &#123;</span><br><span class="line">      cb(END)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    cb(buffer.flush())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当关闭channel时，终止所有任务监听器</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (!closed) &#123;</span><br><span class="line">      closed = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> (takers.length) &#123;</span><br><span class="line">        <span class="keyword">const</span> arr = takers</span><br><span class="line">        takers = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = arr.length; i &lt; len; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> taker = arr[i]</span><br><span class="line">          taker(END)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    take,</span><br><span class="line">    put,</span><br><span class="line">    flush,</span><br><span class="line">    close,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="eventChannel"><a href="#eventChannel" class="headerlink" title="eventChannel"></a>eventChannel</h4><p>eventChannel 是对 channel的封装，主要区别是 <strong>channel.put</strong> 函数交给subscribe函数驱动<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">eventChannel</span>(<span class="params">subscribe, buffer = buffers.none(</span>)) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> closed = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> unsubscribe</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> chan = channel(buffer)</span><br><span class="line">  <span class="keyword">const</span> close = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (is.func(unsubscribe)) &#123;</span><br><span class="line">      unsubscribe()</span><br><span class="line">    &#125;</span><br><span class="line">    chan.close()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unsubscribe = subscribe(<span class="function"><span class="params">input</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isEnd(input)) &#123;</span><br><span class="line">      close()</span><br><span class="line">      closed = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    chan.put(input)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is.func(unsubscribe)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'in eventChannel: subscribe should return a function to unsubscribe'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unsubscribe = once(unsubscribe)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">    unsubscribe()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    take: chan.take,</span><br><span class="line">    flush: chan.flush,</span><br><span class="line">    close,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>example:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个channel刚建立就被关闭了</span></span><br><span class="line">eventChannel(<span class="function"><span class="params">emitter</span> =&gt;</span> &#123;</span><br><span class="line">  emitter(END)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="cancel"><a href="#cancel" class="headerlink" title="cancel"></a>cancel</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">test</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">yield</span> call(delayUtil, <span class="number">5000</span>);</span><br><span class="line">    <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">text</span>: action.text  &#125;);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">yield</span> cancelled()) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'cancelled'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> action = <span class="keyword">yield</span> take(<span class="string">'ADD_TODO_SAGA'</span>);</span><br><span class="line">  <span class="keyword">const</span> task = <span class="keyword">yield</span> fork(test, action);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">yield</span> call(delayUtil, <span class="number">4000</span>);</span><br><span class="line">  <span class="keyword">yield</span> cancel(task);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sagaMiddleware.run(rootSaga)</span><br></pre></td></tr></table></figure>
<p>这里首先监听了ADD_TODO_SAGA事件，在4s之后又取消了任务，由于在子任务中延时了5s，所以 ADD_TODO 并没有被抛出。</p>
<h4 id="cancel-effect"><a href="#cancel-effect" class="headerlink" title="cancel effect"></a>cancel effect</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cancelSingleTask</span>(<span class="params">taskToCancel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (taskToCancel.isRunning()) &#123;</span><br><span class="line">    taskToCancel.cancel()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到调用task的cancel方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cancel</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (task._isRunning &amp;&amp; !task._isCancelled) &#123;</span><br><span class="line">    task._isCancelled = <span class="literal">true</span></span><br><span class="line">    taskQueue.cancelAll()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际执行的就是 taskQueue.cancelAll() 在这里取消了任务及其子任务。</p>
<h4 id="cancelled-effect"><a href="#cancelled-effect" class="headerlink" title="cancelled effect"></a>cancelled effect</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runCancelledEffect</span>(<span class="params">data, cb</span>) </span>&#123;</span><br><span class="line">  cb(<span class="built_in">Boolean</span>(mainTask._isCancelled))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接将_isCancelled作为结果</p>
<p>由于取消任务是在父线程上作的，所以应该通知到子线程上。<br>原理是当迭代器运行return方法时，<code>iterator.return()</code> 函数就会跳过try剩下的语句，直接进入finally代码块。这里改造一下之前的自动流程控制demo<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> delay = <span class="function">(<span class="params">ms</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(res, ms);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'begin'</span>);</span><br><span class="line">    <span class="keyword">yield</span> delay(<span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1s later'</span>);</span><br><span class="line">    <span class="keyword">yield</span> delay(<span class="number">2000</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'end'</span>);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finally'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autoRun</span>(<span class="params">gfunc</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> gen = gfunc();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = gen.next();</span><br><span class="line">    gen.return(<span class="string">'cancel'</span>);</span><br><span class="line">    <span class="keyword">if</span> (res.done) <span class="keyword">return</span>;</span><br><span class="line">    res.value.then(next);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">autoRun(main);</span><br><span class="line"><span class="comment">// begin</span></span><br><span class="line"><span class="comment">// finish</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到直接进入了finally代码块。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这边文章主要是对前一篇文章的补充，探索了一下我比较感兴趣的两个点，也希望读者看完之后会有所帮助。<br>接下来我会分析一下dva（基于 redux、redux-saga 和 react-router 的轻量级前端框架）</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars3.githubusercontent.com/u/16717283?s=460&v=4"
               alt="山石岩" />
          <p class="site-author-name" itemprop="name">山石岩</p>
           
              <p class="site-description motion-element" itemprop="description">大前端</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">山石岩</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"your-duoshuo-shortname"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  














  





  

  

  

  

  

  

</body>
</html>
